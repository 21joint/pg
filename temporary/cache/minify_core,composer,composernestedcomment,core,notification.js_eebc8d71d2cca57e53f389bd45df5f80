en4.nestedcomment={editCommentInfo:{}};var tempUnlike=0;var tempLike=0;var postComment='<?php echo Engine_Api::_()->getApi("settings", "core")->getSetting("nestedcomment.comment.public", 1); ?>';en4.nestedcomment.nestedcomments={loadCommentReplies:function(comment_id){$$('.reply'+comment_id).setStyle('display','inline-block');$('replies_show_'+comment_id).setStyle('display','none');$('replies_hide_'+comment_id).setStyle('display','inline-block');},hideCommentReplies:function(comment_id){$$('.reply'+comment_id).setStyle('display','none');$('replies_hide_'+comment_id).setStyle('display','none');$('replies_show_'+comment_id).setStyle('display','inline-block');},showReplyEditForm:function(reply_id,is_enter_submit){if(document.getElementsByClassName('reply_edit')){var elements=document.getElementsByClassName('reply_edit');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
if(document.getElementsByClassName('comment_edit')){var elements=document.getElementsByClassName('comment_edit');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
var elements=document.getElementsByClassName('comments_body')
for(var i=0;i<elements.length;i++){elements[i].style.display='inline-block';}
if($('activity-reply-edit-form-'+reply_id).getElementById('compose-container')==null){en4.nestedcomment.nestedcomments.attachReply($('activity-reply-edit-form-'+reply_id),is_enter_submit,'edit');if($('seaocore_comments_attachment_'+reply_id))
$('seaocore_comments_attachment_'+reply_id).destroy();$('activity-reply-edit-form-'+reply_id).body.value=replyAttachment.editReply[reply_id].body;}
$('activity-reply-edit-form-'+reply_id).style.display='block';$('reply_body_'+reply_id).style.display='none';$('reply_edit_'+reply_id).style.display='block';},showCommentEditForm:function(comment_id,is_enter_submit){if(document.getElementsByClassName('reply_edit')){var elements=document.getElementsByClassName('reply_edit');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
if(document.getElementsByClassName('comment_edit')){var elements=document.getElementsByClassName('comment_edit');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
var elements=document.getElementsByClassName('comments_body')
for(var i=0;i<elements.length;i++){elements[i].style.display='inline-block';}
if($('activity-comment-edit-form-'+comment_id).getElementById('compose-container')==null){en4.nestedcomment.nestedcomments.attachComment($('activity-comment-edit-form-'+comment_id),is_enter_submit,'edit');if($('seaocore_comments_attachment_'+comment_id))
$('seaocore_comments_attachment_'+comment_id).destroy();$('activity-comment-edit-form-'+comment_id).body.value=commentAttachment.editComment[comment_id].body;}
$('activity-comment-edit-form-'+comment_id).style.display='block';$('comments_body_'+comment_id).style.display='none';$('comment_edit_'+comment_id).style.display='block';},comment:function(action_id,body,extendClass,formElementPhotoValue,formElementTypeValue,formElementPhotoSrc,form_values,action,comment_id,ignore){if(body.trim()==''&&formElementPhotoValue==''&&!ignore)
{return;}
var show_all_comments_value=0;if(typeof show_all_comments!='undefined'){show_all_comments_value=show_all_comments.value;}
if(formElementPhotoSrc){var CommentHTML='<div class="comments_author_photo"><a href="'+en4.user.viewer.href+'" ><img src="'+en4.user.viewer.iconUrl+'"  class="thumb_icon item_photo_user  thumb_icon"></a></div><div class="comments_info"><span class="comments_author"><a href="'+en4.user.viewer.href+'" class="sea_add_tooltip_link" rel="user 1">'+en4.user.viewer.title+'</a></span><span class="comments_body">'+body+'</span><div class="seaocore_comments_attachment" id="seaocore_comments_attachment"><div class="seaocore_comments_attachment_photo"><a><img src="'+formElementPhotoSrc+'" alt="" class="thumbs_photo thumb_normal item_photo_album_photo  thumb_normal"></a><div class="seaocore_comments_attachment_info"><div class="seaocore_comments_attachment_title"></div><div class="seaocore_comments_attachment_des"></div></div></div><ul class="comments_date"><li class="comments_timestamp">'+en4.advancedactivity.fewSecHTML+'</li></ul></div><div class="comments"></div>';}else{var CommentHTML='<div class="comments_author_photo"><a href="'+en4.user.viewer.href+'" ><img src="'+en4.user.viewer.iconUrl+'"  class="thumb_icon item_photo_user  thumb_icon"></a></div><div class="comments_info"><span class="comments_author"><a href="'+en4.user.viewer.href+'" class="sea_add_tooltip_link" rel="user 1">'+en4.user.viewer.title+'</a></span><span class="comments_body">'+body+'</span><ul class="comments_date"><li class="comments_timestamp">'+en4.advancedactivity.fewSecHTML+'</li></ul></div><div class="comments"></div>';}
if(action=='create'){if($("feed-comment-form-open-li_"+extendClass+action_id)){new Element('li',{'html':CommentHTML,}).inject($("feed-comment-form-open-li_"+extendClass+action_id),'before');}else{new Element('li',{'html':CommentHTML,}).inject($('comment-likes-activity-item-'+extendClass+action_id).getElement('.comments').getElement('ul'));}}
form_values+='&format=json';form_values+='&subject='+en4.core.subject.guid;form_values+='&isShare='+adfShare;form_values+='&show_all_comments='+show_all_comments_value;form_values+='&onViewPage='+extendClass;form_values+='&photo_id='+formElementPhotoValue;form_values+='&type='+formElementTypeValue;var url;if(action=='create'){url=en4.core.baseUrl+'advancedactivity/index/comment';}else if(action=='edit'){url=en4.core.baseUrl+'nestedcomment/index/comment-edit';$('comment-'+comment_id).set('html',CommentHTML);$('comment-'+comment_id).getElement('.comments_date').inject($('comment-'+comment_id).getElement('.comments_info'));$('comment-'+comment_id).getElement('.comments').inject($('comment-'+comment_id));}
en4.core.request.send(new Request.JSON({url:url,data:$merge(form_values.parseQueryString(),{body:body}),onComplete:function(e){}}),{'force':true,'element':$('comment-likes-activity-item-'+extendClass+action_id)});},reply:function(comment_id,body,extendClass,action_id,formElementPhotoValue,formElementTypeValue,formElementPhotoSrc,form_values,action,ignore){if(body.trim()==''&&formElementPhotoValue==''&&!ignore)
{return;}
var show_all_comments_value=0;if(typeof show_all_comments!='undefined'){show_all_comments_value=show_all_comments.value;}
if(formElementPhotoSrc){var CommentHTML='<div class="comments_author_photo"><a href="'+en4.user.viewer.href+'" ><img src="'+en4.user.viewer.iconUrl+'"  class="thumb_icon item_photo_user  thumb_icon"></a></div><div class="comments_info"><span class="comments_author"><a href="'+en4.user.viewer.href+'" class="sea_add_tooltip_link" rel="user 1">'+en4.user.viewer.title+'</a></span><span class="comments_body">'+body+'</span><div class="seaocore_comments_attachment" id="seaocore_comments_attachment"><div class="seaocore_comments_attachment_photo"><a><img src="'+formElementPhotoSrc+'" alt="" class="thumbs_photo thumb_normal item_photo_album_photo  thumb_normal"></a><div class="seaocore_comments_attachment_info"><div class="seaocore_comments_attachment_title"></div><div class="seaocore_comments_attachment_des"></div></div></div><ul class="comments_date"><li class="comments_timestamp">'+en4.advancedactivity.fewSecHTML+'</li></ul></div><div class="comments"></div>';}else{var CommentHTML='<div class="comments_author_photo"><a href="'+en4.user.viewer.href+'" ><img src="'+en4.user.viewer.iconUrl+'"  class="thumb_icon item_photo_user  thumb_icon"></a></div><div class="comments_info"><span class="comments_author"><a href="'+en4.user.viewer.href+'" class="sea_add_tooltip_link" rel="user 1">'+en4.user.viewer.title+'</a></span><span class="comments_body">'+body+'</span><ul class="comments_date"><li class="comments_timestamp">'+en4.advancedactivity.fewSecHTML+'</li></ul></div><div class="comments"></div>';}
if(action=='create'){if($("feed-reply-form-open-li_"+extendClass+comment_id)){new Element('li',{'html':CommentHTML,}).inject($("feed-reply-form-open-li_"+extendClass+comment_id),'before');}else{new Element('li',{'html':CommentHTML,}).inject($('comment-likes-activity-item-'+extendClass+action_id).getElement('.comments').getElement('ul'));}}
var url;if(action=='create'){url=en4.core.baseUrl+'nestedcomment/index/reply';}else if(action=='edit'){url=en4.core.baseUrl+'nestedcomment/index/reply-edit';$('reply-'+comment_id).innerHTML=CommentHTML;$('reply-'+comment_id).getElement('.comments_date').inject($('reply-'+comment_id).getElement('.comments_info'));$('reply-'+comment_id).getElement('.comments').inject($('reply-'+comment_id));}
form_values+='&format=json';form_values+='&subject='+en4.core.subject.guid;form_values+='&isShare='+adfShare;form_values+='&show_all_comments='+show_all_comments_value;form_values+='&onViewPage='+extendClass;form_values+='&photo_id='+formElementPhotoValue;form_values+='&type='+formElementTypeValue;en4.core.request.send(new Request.JSON({url:url,data:$merge(form_values.parseQueryString(),{body:body}),}),{'force':true,'element':$('comment-likes-activity-item-'+extendClass+action_id)});},attachComment:function(formElement,is_enter_submit,action,body){var bind=this;var hasViewPage=formElement.get('id').indexOf('view')<0?0:1;var extendClass='';if(hasViewPage){extendClass='view-';}
var comment_id=0;if(action!=='edit'){action='create';}else{comment_id=formElement.comment_id.value;}
var composerObj=new ComposerNestedActivityComment($(formElement.body.get('id')),{overText:true,lang:{'Post Something...':en4.core.language.translate('Write a comment...')},allowEmptyWithAttachment:false,submitElement:'submit',hideSubmitOnBlur:false});formElement.store('composer',composerObj);var menuIndex=1;if(typeof action!='undefined'&&action=='edit'&&commentAttachment.editComment[formElement.comment_id.value].body!=''){composerObj.setContent(commentAttachment.editComment[formElement.comment_id.value].body);composerObj.focus();formElement.store('composer',composerObj);}
composerObj.addPlugin(new ComposerNestedActivityComment.Plugin.Tag({enabled:true,suggestOptions:{'url':en4.core.baseUrl+'nestedcomment/friends/suggest-tag/includeSelf/1','postData':{'format':'json','subject':en4.core.subject.guid,'taggingContent':activityTaggingContent},'maxChoices':10},'suggestProto':'request.json'}));if(smiliesEnabled){var emoticons_parent_icons=new Element('div',{'id':'emoticons-parent-icons_'+formElement.get('id'),'class':'seao_emoticons'}).inject(composerObj.getMenu());emoticons_parent_icons.innerHTML=$('emoticons-comment-icons').innerHTML;emoticons_parent_icons.getElementById('emoticons-comment-button').setAttribute('id','emoticons-comment-button_'+formElement.get('id'));emoticons_parent_icons.getElementById('emotion_comment_label').setAttribute('id','emotion_comment_label_'+formElement.get('id'));emoticons_parent_icons.getElementById('emotion_comment_symbol').setAttribute('id','emotion_comment_symbol_'+formElement.get('id'));emoticons_parent_icons.getElementById('emoticons-comment-board').setAttribute('id','emoticons-comment-board_'+formElement.get('id'));menuIndex++;}
var attachment=action=='edit'?commentAttachment.editComment[formElement.comment_id.value].attachment_body:false;if(photoEnabled){var commentNestedPhoto=new commentPhoto();commentNestedPhoto.getPhotoContent(formElement.get('id'),{requestOptions:{'url':requestOptionsURLNestedComment},fancyUploadOptions:{'url':fancyUploadOptionsURLNestedComment,'path':en4.core.basePath+'externals/fancyupload/Swiff.Uploader.swf'}});if(attachment&&attachment.type==='album_photo'){commentNestedPhoto.activate();commentNestedPhoto.doProcessResponse(attachment);}
menuIndex++;}
if(ComposerNestedActivityComment.Plugin.Sticker){composerObj.addPlugin(new ComposerNestedActivityComment.Plugin.Sticker({title:en4.core.language.translate('Post a sticker'),attachment:attachment,menuIndex:menuIndex}));menuIndex++;}
var formElementPhotoValue='';var formElementTypeValue='';var formElementPhotoSrc='';var onSubmitComment=function(event){event.stop();if(formElement.photo_id&&formElement.photo_id.value)
formElementPhotoValue=formElement.photo_id.value;if(formElement.type&&formElement.type.value)
formElementTypeValue=formElement.type.value;if(formElement.src&&formElement.src.value)
formElementPhotoSrc=formElement.src.value;if((formElementPhotoValue==''&&composerObj.getContent()==''&&!composerObj.pluginReady)||formElement.retrieve('sendReq',false))
{return;}
if(composerObj.getPlugin('tag')&&composerObj.getPlugin('tag').getAAFTagsFromComposer().toQueryString()!='')
composerObj.getPlugin('tag').getComposer().fireEvent('editorSubmit');var form_values=composerObj.getForm().toQueryString();form_values=form_values.replace("body=&","");bind.comment(formElement.action_id.value,composerObj.getContent(),extendClass,formElementPhotoValue,formElementTypeValue,formElementPhotoSrc,form_values,action,comment_id,true);formElement.body.value='';formElement.style.display="none";};if(is_enter_submit==1){formElement.addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',function(event){if(event.shift&&event.key=='enter'){}else if(event.key=='enter'){event.stop();onSubmitComment(event);}});}
formElement.addEvent('submit',onSubmitComment.bind(this));},attachReply:function(formElement,is_enter_submit,action,body){var bind=this;var hasViewPage=formElement.get('id').indexOf('view')<0?0:1;var extendClass='';if(hasViewPage){extendClass='view-';}
var comment_id=0;if(action!=='edit'){action='create';}else{comment_id=formElement.comment_id.value;}
var composerObj=new ComposerNestedActivityComment($(formElement.body.get('id')),{overText:true,lang:{'Post Something...':en4.core.language.translate('Write a reply...')},hideSubmitOnBlur:false,allowEmptyWithAttachment:false,submitElement:'submit'});if(typeof action!='undefined'&&action=='edit'&&replyAttachment.editReply[formElement.comment_id.value].body!=''){composerObj.setContent(replyAttachment.editReply[formElement.comment_id.value].body);composerObj.focus();}
formElement.store('composer',composerObj);composerObj.addPlugin(new ComposerNestedActivityComment.Plugin.Tag({enabled:true,suggestOptions:{'url':en4.core.baseUrl+'nestedcomment/friends/suggest-tag/includeSelf/1','postData':{'format':'json','subject':en4.core.subject.guid,'taggingContent':activityTaggingContent},'maxChoices':10},'suggestProto':'request.json'}));var menuIndex=1;if(smiliesEnabled){var emoticons_parent_icons=new Element('div',{'id':'emoticons-parent-icons_'+formElement.get('id'),'class':'seao_emoticons'}).inject(composerObj.getMenu());emoticons_parent_icons.innerHTML=$('emoticons-comment-icons').innerHTML;if(is_enter_submit==0){}
emoticons_parent_icons.getElementById('emoticons-comment-button').setAttribute('id','emoticons-comment-button_'+formElement.get('id'));emoticons_parent_icons.getElementById('emotion_comment_label').setAttribute('id','emotion_comment_label_'+formElement.get('id'));emoticons_parent_icons.getElementById('emotion_comment_symbol').setAttribute('id','emotion_comment_symbol_'+formElement.get('id'));emoticons_parent_icons.getElementById('emoticons-comment-board').setAttribute('id','emoticons-comment-board_'+formElement.get('id'));menuIndex++;}
var attachment=action=='edit'?replyAttachment.editReply[formElement.comment_id.value].attachment_body:false;if(photoEnabled){var commentNestedPhoto=new commentPhoto();commentNestedPhoto.getPhotoContent(formElement.get('id'),{requestOptions:{'url':requestOptionsURLNestedComment},fancyUploadOptions:{'url':fancyUploadOptionsURLNestedComment,'path':en4.core.basePath+'externals/fancyupload/Swiff.Uploader.swf'}});if(attachment&&attachment.type==='album_photo'){commentNestedPhoto.activate();commentNestedPhoto.doProcessResponse(attachment);}
menuIndex++;}
if(ComposerNestedActivityComment.Plugin.Sticker){composerObj.addPlugin(new ComposerNestedActivityComment.Plugin.Sticker({title:en4.core.language.translate('Post a sticker'),attachment:attachment,menuIndex:menuIndex}));menuIndex++;}
var formElementPhotoValue='';var formElementTypeValue='';var formElementPhotoSrc='';var onSubmitReply=function(event){event.stop();if(formElement.photo_id&&formElement.photo_id.value)
formElementPhotoValue=formElement.photo_id.value;if(formElement.type&&formElement.type.value)
formElementTypeValue=formElement.type.value;if(formElement.src&&formElement.src.value)
formElementPhotoSrc=formElement.src.value;if(composerObj.getPlugin('tag')&&composerObj.getPlugin('tag').getAAFTagsFromComposer().toQueryString()!='')
composerObj.getPlugin('tag').getComposer().fireEvent('editorSubmit');if((formElementPhotoValue==''&&composerObj.getContent()==''&&!composerObj.pluginReady)||formElement.retrieve('sendReq',false))
{return;}
var form_values=composerObj.getForm().toQueryString();form_values=form_values.replace("body=&","");bind.reply(comment_id,composerObj.getContent(),extendClass,formElement.action_id.value,formElementPhotoValue,formElementTypeValue,formElementPhotoSrc,form_values,action,true);formElement.body.value='';formElement.style.display="none";};if(is_enter_submit==1){formElement.addEvent((Browser.Engine.trident||Browser.Engine.webkit)?'keydown':'keypress',function(event){if(event.shift&&event.key=='enter'){}else if(event.key=='enter'){onSubmitReply(event);}});}
formElement.addEvent('submit',onSubmitReply.bind(this));},loadComments:function(type,id,page,order,parent_comment_id,taggingContent,pre,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies){if($('view_more_comments_'+parent_comment_id)&&pre==3){$('view_more_comments_'+parent_comment_id).style.display='inline-block';$('view_more_comments_'+parent_comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
if($('view_previous_comments_'+parent_comment_id)&&pre==2){$('view_previous_comments_'+parent_comment_id).style.display='inline-block';$('view_previous_comments_'+parent_comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
if($('view_later_comments_'+parent_comment_id)&&pre==1){$('view_later_comments_'+parent_comment_id).style.display='inline-block';$('view_later_comments_'+parent_comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'nestedcomment/comment/list',data:{format:'html',type:type,id:id,page:page,order:order,parent_div:1,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder}}),{'element':$('comments'+'_'+type+'_'+id+'_'+parent_comment_id)});},loadcommentssortby:function(type,id,order,parent_comment_id,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies){if($('sort'+'_'+type+'_'+id+'_'+parent_comment_id)){$('sort'+'_'+type+'_'+id+'_'+parent_comment_id).style.display='inline-block';$('sort'+'_'+type+'_'+id+'_'+parent_comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'nestedcomment/comment/list',data:{format:'html',type:type,id:id,order:order,parent_div:1,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder}}),{'element':$('comments'+'_'+type+'_'+id+'_'+parent_comment_id)});},like:function(type,id,comment_id,order,parent_comment_id,option,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies,page,reaction){if(tempLike==0){tempUnlike=tempLike=1;if($('like_comments_'+comment_id)&&(option=='child')){$('like_comments_'+comment_id).style.display='inline-block';$('like_comments_'+comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
if($('like_comments_'+type+'_'+id)&&(option=='parent')){$('like_comments_'+type+'_'+id).style.display='inline-block';$('like_comments_'+type+'_'+id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'nestedcomment/comment/like',data:{format:'json',type:type,id:id,comment_id:comment_id,order:order,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,page:page,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder,reaction:reaction},onComplete:function(e){tempUnlike=tempLike=0;if($('sitereview_most_likes_'+id)){$('sitereview_most_likes_'+id).style.display='none';}
if($('sitereview_unlikes_'+id)){$('sitereview_unlikes_'+id).style.display='block';}}}),{'element':$('comments'+'_'+type+'_'+id+'_'+parent_comment_id)});}},unlike:function(type,id,comment_id,order,parent_comment_id,option,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies,page){if(tempUnlike==0){tempLike=tempUnlike=1;if($('unlike_comments_'+comment_id)&&(option=='child')){$('unlike_comments_'+comment_id).style.display='inline-block';$('unlike_comments_'+comment_id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
if($('unlike_comments_'+type+'_'+id)&&(option=='parent')){$('unlike_comments_'+type+'_'+id).style.display='inline-block';$('unlike_comments_'+type+'_'+id).innerHTML='<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading" />';}
en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'nestedcomment/comment/unlike',data:{format:'json',type:type,id:id,comment_id:comment_id,order:order,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,page:page,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder},onComplete:function(e){tempLike=tempUnlike=0;if($('sitereview_most_likes_'+id)){$('sitereview_most_likes_'+id).style.display='block';}
if($('sitereview_unlikes_'+id)){$('sitereview_unlikes_'+id).style.display='none';}}}),{'element':$('comments'+'_'+type+'_'+id+'_'+parent_comment_id)});}},showLikes:function(type,id,order,parent_comment_id,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies){en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'nestedcomment/comment/list',data:{format:'html',type:type,id:id,viewAllLikes:true,order:order,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder}}),{'element':$('comments'+'_'+type+'_'+id+'_'+parent_comment_id)});},deleteComment:function(type,id,comment_id,order,parent_comment_id,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies){if(!confirm(en4.core.language.translate('Are you sure you want to delete this?'))){return;}
if($('comment-'+comment_id)){$('comment-'+comment_id).destroy();}
(new Request.JSON({url:en4.core.baseUrl+'nestedcomment/comment/delete',data:{format:'json',type:type,id:id,comment_id:comment_id,order:order,parent_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder},onComplete:function(e){try{var replyCount=$$('.seaocore_replies_options span')[0];var m=replyCount.get('html').match(/\d+/);var newCount=(parseInt(m[0])!='NaN'&&parseInt(m[0])>1?parseInt(m[0])-1:0);replyCount.set('html',replyCount.get('html').replace(m[0],e.commentsCount));if(e.commentsCount==0||e.commentsCount==1){if($("seaocore_replies_sorting"))
$("seaocore_replies_sorting").style.display='none';if($("seaocore_replies_li"))
$("seaocore_replies_li").style.display='none';}}catch(e){}}})).send();}};function showReplyData(option,id){if(option==1){if($('seaocore_data-'+id))
$('seaocore_data-'+id).style.display='none';if($('comment-'+id))
$('comment-'+id).className="seaocore_replies_list seaocore_comments_hide";if($('show_'+id))
$('show_'+id).style.display='block';if($('hide_'+id))
$('hide_'+id).style.display='none';}else{if($('seaocore_data-'+id))
$('seaocore_data-'+id).style.display='block';if($('show_'+id))
$('show_'+id).style.display='none';if($('hide_'+id))
$('hide_'+id).style.display='block';if($('comment-'+id))
$('comment-'+id).className="seaocore_replies_list";}}
function sortComments(order,type,id,parent_comment_id,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies){en4.nestedcomment.nestedcomments.loadcommentssortby(type,id,order,parent_comment_id,taggingContent,showAsNested,showAsLike,showDislikeUsers,showLikeWithoutIcon,showLikeWithoutIconInReplies);}
function showReplyForm(type,id,comment_id){if(document.getElementsByClassName('comments_form_nestedcomments_comments')){var elements=document.getElementsByClassName('comments_form_nestedcomments_comments');for(var i=0;i<elements.length;i++){if(elements[i]!=$('comments-form_'+type+'_'+id+'_'+comment_id)){elements[i].style.display='none';}}}
$('comments-form_'+type+'_'+id+'_'+comment_id).body.focus();if($('comments-form_'+type+'_'+id+'_'+comment_id).style.display=='none'){$('comments-form_'+type+'_'+id+'_'+comment_id).style.display='block';$('comments-form_'+type+'_'+id+'_'+comment_id).body.focus();if(($('comments-form_'+type+'_'+id+'_'+comment_id).getElementById('compose-container'))==null){makeComposer($($('comments-form_'+type+'_'+id+'_'+comment_id).body).id,type,id,comment_id,null,'Write a reply...');tagContentComment();}}
else{$('comments-form_'+type+'_'+id+'_'+comment_id).style.display='none';}}
function showEditForm(type,id,comment_id,parent_comment_id){showReplyData(0,comment_id);if(document.getElementsByClassName('comment_edit')){var elements=document.getElementsByClassName('comment_edit');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
if(document.getElementsByClassName('seaocore_replies_comment')){var elements=document.getElementsByClassName('seaocore_replies_comment');for(var i=0;i<elements.length;i++){elements[i].style.display='block';}}
if(document.getElementsByClassName('comment_close')){var elements=document.getElementsByClassName('comment_close');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
if($('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).style.display==''||$('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).style.display=='none'){$('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).style.display='block';$('seaocore_edit_comment_'+comment_id).style.display='block';$('seaocore_comment_data-'+comment_id).style.display='none';if($('close_edit_box-'+comment_id)){$('close_edit_box-'+comment_id).style.display='block';}}else{$('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).style.display='none';$('seaocore_edit_comment_'+comment_id).style.display='none';$('seaocore_comment_data-'+comment_id).style.display='block';if($('close_edit_box-'+comment_id))
$('close_edit_box-'+comment_id).style.display='none';}
$('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).body.focus();if(($('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).getElementById('compose-container'))==null){makeComposer($($('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id).body).id,type,id,comment_id,parent_comment_id);tagContentComment();}}
var makePhotoComposer=function(){if(composeInstanceComment.options.type)
type=composeInstanceComment.options.type;composeInstanceComment.addPlugin(new ComposerNestedComment.Plugin.Photo({title:'Add Photo',lang:{'Add Photo':en4.core.language.translate('Add Photo'),'Select File':en4.core.language.translate('Select File'),'cancel':en4.core.language.translate('cancel'),'Loading...':en4.core.language.translate('Loading...'),'Unable to upload photo. Please click cancel and try again':en4.core.language.translate('Unable to upload photo. Please click cancel and try again')},requestOptions:{'url':en4.core.baseUrl+'nestedcomment/album/compose-upload/type/comment'},fancyUploadOptions:{'url':en4.core.baseUrl+'nestedcomment/album/compose-upload/format/json/type/comment','path':en4.core.basePath+'externals/fancyupload/Swiff.Uploader.swf'}}));}
var makeLinkComposer=function(){composeInstanceComment.addPlugin(new ComposerNestedComment.Plugin.Link({title:en4.core.language.translate('Add Link'),lang:{'cancel':en4.core.language.translate('cancel'),'Last':en4.core.language.translate('Last'),'Next':en4.core.language.translate('Next'),'Attach':en4.core.language.translate('Attach'),'Loading...':en4.core.language.translate('Loading...'),'Don\'t show an image':en4.core.language.translate('Don\'t show an image'),'Choose Image:':en4.core.language.translate('Choose Image:'),'%d of %d':en4.core.language.translate('%d of %d')},requestOptions:{'url':en4.core.baseUrl+'core/link/preview'}}));}
var makeStickerComposer=function(attachment){if(!ComposerNestedComment.Plugin.Sticker){return;}
composeInstanceComment.addPlugin(new ComposerNestedComment.Plugin.Sticker({title:en4.core.language.translate('Post a sticker'),attachment:attachment}));}
function makeComposer(body,type,id,comment_id,parent_comment_id,overtext){if(typeof parent_comment_id!='undefined'&&parent_comment_id!=null){menuElement='compose-containe-menu-items_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id;var formEle=$('comments-form_'+type+'_'+id+'_'+parent_comment_id+'_'+comment_id);}else{menuElement='compose-containe-menu-items_'+type+'_'+id+'_'+comment_id;var formEle=$('comments-form_'+type+'_'+id+'_'+comment_id);}
var lanText='Write a comment...';if(typeof overtext!='undefined'){lanText=overtext;}
composeInstanceComment=new ComposerNestedComment(body,{menuElement:menuElement,baseHref:en4.core.baseUrl,lang:{'Post Something...':en4.core.language.translate('Write a comment...')},type:type,id:id,parent_comment_id:comment_id,edit_comment_id:parent_comment_id,taggingContent:taggingContent,showAsNested:showAsNested,showAsLike:showAsLike,showDislikeUsers:showDislikeUsers,showLikeWithoutIcon:showLikeWithoutIcon,showLikeWithoutIconInReplies:showLikeWithoutIconInReplies,overText:true,showLangText:lanText,showSmilies:showSmilies,photoLightboxComment:photoLightboxComment,commentsorder:commentsorder});var attachment=null;if(typeof parent_comment_id!='undefined'&&parent_comment_id!=null&&en4.nestedcomment.editCommentInfo[comment_id]){attachment=en4.nestedcomment.editCommentInfo[comment_id].attachment_body;}
if(showAddPhoto==1&&en4.user.viewer.id){makePhotoComposer();}
if(showAddLink==1&&en4.user.viewer.id){makeLinkComposer();}
makeStickerComposer(attachment);if(showSmilies==1){makeSmilies(formEle,menuElement);}
if(typeof parent_comment_id!='undefined'&&parent_comment_id!=null){composerContent=$('seaocore_comment_data-'+comment_id);if(composerContent.getElementById('seaocore_comments_attachment'))
composerContent.removeChild(composerContent.getElementById('seaocore_comments_attachment'));composeInstanceComment.setContent(en4.nestedcomment.editCommentInfo[comment_id].body);if(en4.nestedcomment.editCommentInfo[comment_id].attachment_type=='album_photo'){composeInstanceComment.getPlugin('photo').activate();composeInstanceComment.getPlugin('photo').doProcessResponse(en4.nestedcomment.editCommentInfo[comment_id].attachment_body);}else if(en4.nestedcomment.editCommentInfo[comment_id].attachment_type=='core_link'){composeInstanceComment.getPlugin('link').activate();composeInstanceComment.getPlugin('link').doAttach(en4.nestedcomment.editCommentInfo[comment_id].attachment_body.url);}else if(en4.nestedcomment.editCommentInfo[comment_id].attachment_type=='sitereaction_sticker'){composeInstanceComment.getPlugin('sticker').activate();composeInstanceComment.getPlugin('sticker').doEditProcess();}}}
function makeSmilies(formEle,menuElement){new Element('a',{'id':'nested-comment-compose-emoticons-activator','class':'compose-activator buttonlink',}).inject($("composer_container_icons_"+formEle.get('action-id')));if(nestedCommentPressEnter==1){var emoticons_parent_icons=new Element('div',{'id':'emoticons-parent-icons_'+formEle.get('id'),'class':'seao_emoticons','styles':{'display':'none'}}).inject(menuElement);emoticons_parent_icons.inject(formEle.getElementById('compose-container'),'after');}
else{var emoticons_parent_icons=new Element('div',{'id':'emoticons-parent-icons_'+formEle.get('id'),'class':'seao_emoticons seao_inside_smile','styles':{'display':'none'}}).inject(menuElement);emoticons_parent_icons.inject($("composer_container_icons_"+formEle.get('action-id')));}
emoticons_parent_icons.innerHTML=$('emoticons-nested-comment-icons').innerHTML;$('emoticons-nested-comment-button').setAttribute('id','emoticons-nested-comment-button_'+formEle.get('id'));$('emotion_nested_comment_label').setAttribute('id','emotion_nested_comment_label_'+formEle.get('id'));$('emotion_nested_comment_symbol').setAttribute('id','emotion_nested_comment_symbol_'+formEle.get('id'));$('emoticons-nested-comment-board').setAttribute('id','emoticons-nested-comment-board_'+formEle.get('id'));}
function tagContentComment(){composeInstanceComment.addPlugin(new ComposerNestedComment.Plugin.Nctag({enabled:true,suggestOptions:{'url':en4.core.baseUrl+'nestedcomment/friends/suggest-tag/includeSelf/1','postData':{'format':'json','subject':en4.core.subject.guid,'taggingContent':taggingContent},'maxChoices':10},'suggestProto':'request.json'}));}
en4.nestedcomment.ajaxTab={click_elment_id:'',attachEvent:function(widget_id,params){params.requestParams.content_id=widget_id;var element;$$('.tab_'+widget_id).each(function(el){if(el.get('tag')=='li'){element=el;return;}});var onloadAdd=true;if(element){if(element.retrieve('addClickEvent',false))
return;element.addEvent('click',function(){if(en4.nestedcomment.ajaxTab.click_elment_id==widget_id)
return;en4.nestedcomment.ajaxTab.click_elment_id=widget_id;en4.nestedcomment.ajaxTab.sendReq(params);});element.store('addClickEvent',true);var attachOnLoadEvent=false;if(widget_id){attachOnLoadEvent=true;}else{$$('.tabs_parent').each(function(element){var addActiveTab=true;element.getElements('ul > li').each(function(el){if(el.hasClass('active')){addActiveTab=false;return;}});element.getElementById('main_tabs').getElements('li:first-child').each(function(el){el.get('class').split(' ').each(function(className){className=className.trim();if(className.match(/^tab_[0-9]+$/)&&className=="tab_"+widget_id){attachOnLoadEvent=true;if(addActiveTab||tab_content_id_sitestore==widget_id){element.getElementById('main_tabs').getElements('ul > li').removeClass('active');el.addClass('active');element.getParent().getChildren('div.'+className).setStyle('display',null);}
return;}});});});}
if(!attachOnLoadEvent)
return;onloadAdd=false;}
en4.core.runonce.add(function(){if(onloadAdd)
params.requestParams.onloadAdd=true;en4.nestedcomment.ajaxTab.click_elment_id=widget_id;en4.nestedcomment.ajaxTab.sendReq(params);});},sendReq:function(params){params.responseContainer.each(function(element){element.empty();new Element('div',{'class':'nestedcomment_profile_loading_image'}).inject(element);});var url=en4.core.baseUrl+'widget';if(params.requestUrl)
url=params.requestUrl;var request=new Request.HTML({url:url,data:$merge(params.requestParams,{format:'html',subject:en4.core.subject.guid,is_ajax_load:true}),evalScripts:true,onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){params.responseContainer.each(function(container){container.empty();Elements.from(responseHTML).inject(container);en4.core.runonce.trigger();Smoothbox.bind(container);});}});request.send();}};var hideCommentEmotionIconClickEnable=false;var hideNestedCommentEmotionIconClickEnable=false;function setCommentEmoticonsBoard(obj){var formEle=obj.getParent('form');$('emotion_comment_label_'+formEle.get('id')).innerHTML="";$('emotion_comment_symbol_'+formEle.get('id')).innerHTML="";hideCommentEmotionIconClickEnable=true;hideNestedCommentEmotionIconClickEnable=true;var a=$('emoticons-comment-button_'+formEle.get('id'));a.toggleClass('emoticons_comment_active');a.toggleClass('');var el=$('emoticons-comment-board_'+formEle.get('id'));var hasClose=el.hasClass("seaocore_comment_embox_closed");$$('.seaocore_comment_embox').removeClass('seaocore_comment_embox_open').addClass('seaocore_comment_embox_closed');if(hasClose){el.removeClass('seaocore_comment_embox_closed').addClass('seaocore_comment_embox_open');}}
function addCommentEmotionIcon(iconCode,obj){var content;var formEle=obj.getParent('form');var composerObj=formEle.retrieve('composer');content=composerObj.elements.body.get('html');content=content.replace(/(<br>)$/g,"");content=content+' '+iconCode;composerObj.setContent(content);$$('div.compose-content').each(function(el,index){if(index==0)
{el.set('tabindex','0');el.focus();}});}
en4.core.runonce.add(function(){$(document.body).addEvent('click',function(e){hideCommentEmotionIconClickEvent();});});function hideCommentEmotionIconClickEvent(){if(!hideCommentEmotionIconClickEnable&&$$('.seaocore_comment_embox')){$$('.seaocore_comment_embox').removeClass('seaocore_comment_embox_open').addClass('seaocore_comment_embox_closed');}
hideCommentEmotionIconClickEnable=false;}
function setCommentEmotionLabelPlate(label,symbol,obj){var formEle=obj.getParent('form');$('emotion_comment_label_'+formEle.get('id')).innerHTML=label;$('emotion_comment_symbol_'+formEle.get('id')).innerHTML=symbol;}
function setNestedCommentEmoticonsBoard(obj){if(composeInstanceComment)
composeInstanceComment.focus();if(nestedCommentPressEnter==1){var formEle=obj.getParent().getParent();}else{var formEle=obj.getParent().getParent().getParent().getParent();}
$('emotion_nested_comment_label_'+formEle.get('id')).innerHTML="";$('emotion_nested_comment_symbol_'+formEle.get('id')).innerHTML="";hideNestedCommentEmotionIconClickEnable=true;hideCommentEmotionIconClickEnable=true;var a=$('emoticons-nested-comment-button_'+formEle.get('id'));a.toggleClass('emoticons_comment_active');a.toggleClass('');var el=$('emoticons-nested-comment-board_'+formEle.get('id'));var hasClose=el.hasClass("seaocore_comment_embox_closed");$$('.seaocore_comment_embox').removeClass('seaocore_comment_embox_open').addClass('seaocore_comment_embox_closed');if(hasClose){el.removeClass('seaocore_comment_embox_closed').addClass('seaocore_comment_embox_open');}}
function addNestedCommentEmotionIcon(iconCode,obj){var content;if('useContentEditable'in composeInstanceComment.options&&composeInstanceComment.options.useContentEditable)
content=composeInstanceComment.elements.body.get('html');else
content=composeInstanceComment.getContent();content=content.replace(/(<br>)$/g,"");content=content+' '+iconCode;composeInstanceComment.setContent(content);$$('div.compose-content').each(function(el,index){if(index==0)
{el.set('tabindex','0');el.focus();}});}
en4.core.runonce.add(function(){$(document.body).addEvent('click',function(e){hideNestedCommentEmotionIconClickEvent();});});function hideNestedCommentEmotionIconClickEvent(){if(!hideNestedCommentEmotionIconClickEnable&&$$('.seaocore_comment_embox')){$$('.seaocore_comment_embox').removeClass('seaocore_comment_embox_open').addClass('seaocore_comment_embox_closed');}
hideNestedCommentEmotionIconClickEnable=false;hideCommentEmotionIconClickEnable=false;}
function setNestedCommentEmotionLabelPlate(label,symbol,obj){if(nestedCommentPressEnter==1){var formEle=obj.getParent().getParent().getParent().getParent();}else{var formEle=obj.getParent().getParent().getParent().getParent().getParent().getParent();}
if($('emotion_nested_comment_label_'+formEle.get('id')))
$('emotion_nested_comment_label_'+formEle.get('id')).innerHTML=label;if($('emotion_nested_comment_symbol_'+formEle.get('id')))
$('emotion_nested_comment_symbol_'+formEle.get('id')).innerHTML=symbol;}
function showCommentBox(comment_box_id,body_box_id){if($(comment_box_id).getElementById('compose-container')==null){en4.nestedcomment.nestedcomments.attachComment($(comment_box_id),allowQuickComment);}else{var composerObj=$(comment_box_id).retrieve('composer');composerObj.focus();}
var elements=$(comment_box_id).getParent().getElementsByClassName('activity-reply-form');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}
$(comment_box_id).style.display='block';$(body_box_id).focus();}
function showReplyBox(reply_box_id,body_box_id){if(document.getElementsByClassName('activity-reply-form')){var elements=document.getElementsByClassName('activity-reply-form');for(var i=0;i<elements.length;i++){if(elements[i]!=$(reply_box_id)){elements[i].style.display='none';}}
var elements=$(reply_box_id).getParent().getParent().getElementsByClassName('activity-comment-form');for(var i=0;i<elements.length;i++){elements[i].style.display='none';}}
if($(reply_box_id).getElementById('compose-container')==null){en4.nestedcomment.nestedcomments.attachReply($(reply_box_id),allowQuickReply);}else{var composerObj=$(reply_box_id).retrieve('composer');composerObj.focus();}
$(reply_box_id).style.display='block';$(body_box_id).focus();}
function showSortComments(){if($('sorting_dropdown_menu').style.display==''||$('sorting_dropdown_menu').style.display=='none'){$('sorting_dropdown_menu').style.display='block';}else{$('sorting_dropdown_menu').style.display='none';}};(function(){var $='id'in document?document.id:window.$;ComposerNestedComment=new Class({Implements:[Events,Options],elements:{},plugins:{},options:{lang:{},overText:true,allowEmptyWithoutAttachment:false,allowEmptyWithAttachment:true,hideSubmitOnBlur:true,submitElement:false,useContentEditable:true,type:'',id:0,parent_comment_id:0,comment_id:0,taggingContent:'',showAsNested:1,showAsLike:1,showDislikeUsers:1,showLikeWithoutIcon:1,showLikeWithoutIconInReplies:1,showLangText:'Write a comment...',showSmilies:1,photoLightboxComment:0,commentsorder:1},initialize:function(element,options){this.setOptions(options);this.elements=new Hash(this.elements);this.plugins=new Hash(this.plugins);this.elements.textarea=$(element);this.elements.textarea.store('Composer');this.attach();this.getTray();this.getMenu();this.pluginReady=false;this.getForm().addEvent('submit',function(e){this.fireEvent('editorSubmit');if(this.pluginReady){if(!this.options.allowEmptyWithAttachment&&this.getContent()==''){e.stop();return;}}else{if(!this.options.allowEmptyWithoutAttachment&&this.getContent()==''){e.stop();return;}}
this.saveContent();e.stop();if(this.getForm().comment_id){comment_id=this.getForm().comment_id.value;parent_comment_id=this.options.edit_comment_id;url=en4.core.baseUrl+'nestedcomment/comment/update';}else{comment_id=this.options.parent_comment_id;parent_comment_id=this.options.parent_comment_id;url=en4.core.baseUrl+'nestedcomment/comment/create';}
if(this.getForm().comment_id){if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id))
this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id).style.display='none';}else{if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id).style.display='none';}
var divEl=new Element('div',{'class':'seaocore_replies_post_loading','html':'<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading">','id':'seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id,'styles':{'display':'inline-block'}});if(this.getForm().comment_id){if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id))
divEl.inject(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id),'after');}else{if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
divEl.inject(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id),'after');}
var form_values=this.getForm().toQueryString();form_values+='&format=json';form_values+='&id='+this.getForm().identity.value;form_values+='&taggingContent='+this.options.taggingContent;form_values+='&showAsNested='+this.options.showAsNested;form_values+='&showAsLike='+this.options.showAsLike;form_values+='&showDislikeUsers='+this.options.showDislikeUsers;form_values+='&showLikeWithoutIcon='+this.options.showLikeWithoutIcon;form_values+='&showLikeWithoutIconInReplies='+this.options.showLikeWithoutIconInReplies;form_values+='&showSmilies='+this.options.showSmilies;form_values+='&photoLightboxComment='+photoLightboxComment;form_values+='&commentsorder='+commentsorder;en4.core.request.send(new Request.JSON({url:url,data:form_values,type:this.options.type,id:this.options.id,onComplete:function(e){if(!en4.user.viewer.id)
advancedMenuUserLoginOrSignUp('login','','');if(parent_comment_id==0)
return;try{var replyCount=$$('.seaocore_replies_options span')[0];var m=replyCount.get('html').match(/\d+/);replyCount.set('html',replyCount.get('html').replace(m[0],e.commentsCount));}catch(e){}},onFailure:function(error){}}),{'element':$('comments'+'_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id)});}.bind(this));},getMenu:function(){if(!$type(this.elements.menu)){this.elements.menu=$try(function(){return $(this.options.menuElement);}.bind(this));if(!$type(this.elements.menu)){this.elements.menu=new Element('div',{'id':'submit','class':'compose-menu'}).inject(this.getForm(),'after');}}
return this.elements.menu;},getTray:function(){if(!$type(this.elements.tray)){this.elements.tray=$try(function(){return $(this.options.trayElement);}.bind(this));if(!$type(this.elements.tray)){this.elements.tray=new Element('div',{'id':'compose-tray','class':'compose-tray','styles':{'display':'none'}}).inject(this.getForm());}}
return this.elements.tray;},getInputArea:function(){if(!$type(this.elements.inputarea)){var form=this.elements.textarea.getParent('form');this.elements.inputarea=new Element('div',{'styles':{'display':'none'}}).inject(form);}
return this.elements.inputarea;},getForm:function(){return this.elements.textarea.getParent('form');},attach:function(){var size=this.elements.textarea.getSize();this.elements.textarea.addClass('compose-textarea').setStyle('display','none');this.elements.container=new Element('div',{'id':'compose-container','class':'compose-container','styles':{}});this.elements.container.wraps(this.elements.textarea);var supportsContentEditable=this._supportsContentEditable();if(supportsContentEditable){this.elements.body=new Element('div',{'class':'compose-content','styles':{'display':'block'},'events':{'keypress':function(event){if(event.key=='a'&&event.control){if(Browser.Engine.gecko){fix_gecko_select_all_contenteditable_bug(this,event);}}}}}).inject(this.elements.textarea,'before');}else{this.elements.body=this.elements.textarea;}
var self=this;this.elements.body.addEvent('blur',function(e){var curVal;if(supportsContentEditable){curVal=this.get('html').replace(/\s/,'').replace(/<[^<>]+?>/ig,'');}else{curVal=this.get('value').replace(/\s/,'').replace(/<[^<>]+?>/ig,'')}
if(''==curVal){if(!Browser.Engine.trident){if(supportsContentEditable){this.set('html','<br />');}else{this.set('value','');}}
if(self.options.hideSubmitOnBlur){(function(){if(!self.hasActivePlugin()){}}).delay(250);}}});if(self.options.hideSubmitOnBlur){this.getMenu().setStyle('display','none');this.elements.body.addEvent('focus',function(e){self.getMenu().setStyle('display','');if(self.getMenu().parentNode.getElementsByClassName('seao_emoticons')){var ele=self.getMenu().parentNode.getElementsByClassName('seao_emoticons');if(typeof ele[0]!='undefined')
ele[0].style.display='block';}});}
if(supportsContentEditable){$(this.elements.body);this.elements.body.contentEditable=true;this.elements.body.designMode='On';['MouseUp','MouseDown','ContextMenu','Click','Dblclick','KeyPress','KeyUp','KeyDown'].each(function(eventName){var method=(this['editor'+eventName]||function(){}).bind(this);this.elements.body.addEvent(eventName.toLowerCase(),method);}.bind(this));this.setContent(this.elements.textarea.value);this.selection=new ComposerNestedComment.Selection(this.elements.body);}else{this.elements.textarea.setStyle('display','');}
if(this.options.overText){new ComposerNestedComment.OverText(this.elements.body,$merge({textOverride:en4.core.language.translate(this._lang(this.options.showLangText)),poll:true,isPlainText:!supportsContentEditable,positionOptions:{position:(en4.orientation=='rtl'?'upperRight':'upperLeft'),edge:(en4.orientation=='rtl'?'upperRight':'upperLeft'),offset:{x:(en4.orientation=='rtl'?-4:4),y:2}}},this.options.overTextOptions));}
this.fireEvent('attach',this);},detach:function(){this.saveContent();this.textarea.setStyle('display','').removeClass('compose-textarea').inject(this.container,'before');this.container.dispose();this.fireEvent('detach',this);return this;},focus:function(){(function(){this.elements.body.focus();this.fireEvent('focus',this);}).bind(this).delay(10);return this;},getContent:function(){if(this._supportsContentEditable()){return this.cleanup(this.elements.body.get('html'));}else{return this.cleanup(this.elements.body.get('value'));}},setContent:function(newContent){if(this._supportsContentEditable()){if(!newContent.trim()&&!Browser.Engine.trident)
newContent='<br />';this.elements.body.set('html',newContent);}else{this.elements.body.set('value',newContent);}
return this;},saveContent:function(){if(this._supportsContentEditable()){this.elements.textarea.set('value',this.getContent());}
return this;},cleanup:function(html){return html.replace(/<(br|p|div)[^<>]*?>/ig,"\r\n").replace(/<[^<>]+?>/ig,' ').replace(/(\r\n?|\n){3,}/ig,"\n\n").trim();},addPlugin:function(plugin){var key=plugin.getName();this.plugins.set(key,plugin);plugin.setComposer(this);return this;},addPlugins:function(plugins){plugins.each(function(plugin){this.addPlugin(plugin);}.bind(this));},getPlugin:function(name){return this.plugins.get(name);},activate:function(name){this.deactivate();this.getMenu().setStyle();this.plugins.get(name).activate();},deactivate:function(){this.plugins.each(function(plugin){plugin.deactivate();if(typeof en4.nestedcomment.editCommentInfo[composeInstanceComment.options.parent_comment_id]!='undefined'&&en4.nestedcomment.editCommentInfo[composeInstanceComment.options.parent_comment_id].attachment_type!=''){en4.nestedcomment.editCommentInfo[composeInstanceComment.options.parent_comment_id].attachment_type='';en4.nestedcomment.editCommentInfo[composeInstanceComment.options.parent_comment_id].attachment_body='';}
if(typeof composeInstanceComment.getForm().comment_id!='undefined'&&composeInstanceComment.getForm().comment_id.value){if($('close_edit_box-'+composeInstanceComment.getForm().comment_id.value))
$('close_edit_box-'+composeInstanceComment.getForm().comment_id.value).style.display='block';}});this.getTray().empty();},signalPluginReady:function(state){this.pluginReady=state;},hasActivePlugin:function(){var active=false;this.plugins.each(function(plugin){active=active||plugin.active;});return active;},editorMouseUp:function(e){this.fireEvent('editorMouseUp',e);},editorMouseDown:function(e){this.fireEvent('editorMouseDown',e);},editorContextMenu:function(e){this.fireEvent('editorContextMenu',e);},editorClick:function(e){if(Browser.Engine.webkit){var el=e.target;if(el.get('tag')=='img'){this.selection.selectNode(el);}}
this.fireEvent('editorClick',e);},editorDoubleClick:function(e){this.fireEvent('editorDoubleClick',e);},editorKeyPress:function(e){this.keyListener(e);this.fireEvent('editorKeyPress',e);},editorKeyUp:function(e){if(e.key=='esc'){if(this.getForm().comment_id){comment_id=this.getForm().comment_id.value;if($('close_edit_box-'+comment_id))
$('close_edit_box-'+comment_id).style.display='none';if($('seaocore_edit_comment_'+comment_id))
$('seaocore_edit_comment_'+comment_id).style.display='none';if($('seaocore_comment_data-'+comment_id))
$('seaocore_comment_data-'+comment_id).style.display='block';if($('comments-form_'+this.options.type+'_'+this.options.id+'_'+this.options.edit_comment_id+'_'+comment_id))
$('comments-form_'+this.options.type+'_'+this.options.id+'_'+this.options.edit_comment_id+'_'+comment_id).style.display='none';}}
this.fireEvent('editorKeyUp',e);},editorKeyDown:function(e){if(e.key=='enter'){if(this.getForm().comment_id){comment_id=this.getForm().comment_id.value;parent_comment_id=this.options.edit_comment_id;url=en4.core.baseUrl+'nestedcomment/comment/update';}else{comment_id=this.options.parent_comment_id;parent_comment_id=this.options.parent_comment_id;url=en4.core.baseUrl+'nestedcomment/comment/create';}
if(this.getForm().getElementsByClassName('seao_emoticons')){var ele=this.getForm().getElementsByClassName('seao_emoticons');if(typeof ele[0]!='undefined')
ele[0].style.display='none';}
if(nestedCommentPressEnter==1){if(this.pluginReady){if(!this.options.allowEmptyWithAttachment&&this.getContent()==''){e.stop();return;}}else{if(!this.options.allowEmptyWithoutAttachment&&this.getContent()==''){e.stop();return;}}
e.preventDefault();if(composeInstanceComment.getPlugin('tag')&&composeInstanceComment.getPlugin('tag').getAAFTagsFromComposer().toQueryString()!='')
composeInstanceComment.getPlugin('tag').getComposer().fireEvent('editorSubmit');if($('seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
$('seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id).destroy();if(this.getForm().comment_id){if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id))
this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id).style.display='none';}else{if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id).style.display='none';}
var divEl=new Element('div',{'class':'seaocore_replies_post_loading','html':'<img src="application/modules/Seaocore/externals/images/core/loading.gif" alt="Loading">','id':'seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id,'styles':{'display':'inline-block'}});if(this.getForm().comment_id){if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id))
divEl.inject(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id+'_'+comment_id),'after');}else{if(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
divEl.inject(this.getForm().getElementById('compose-containe-menu-items_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id),'after');}
this.getForm().body.value=this.getContent();var form_values=this.getForm().toQueryString();form_values+='&format=json';form_values+='&id='+this.getForm().identity.value;form_values+='&taggingContent='+this.options.taggingContent;form_values+='&showAsNested='+this.options.showAsNested;form_values+='&showAsLike='+this.options.showAsLike;form_values+='&showDislikeUsers='+this.options.showDislikeUsers;form_values+='&showLikeWithoutIcon='+this.options.showLikeWithoutIcon;form_values+='&showLikeWithoutIconInReplies='+this.options.showLikeWithoutIconInReplies;form_values+='&showSmilies='+this.options.showSmilies;form_values+='&photoLightboxComment='+photoLightboxComment;form_values+='&commentsorder='+commentsorder;en4.core.request.send(new Request.JSON({url:url,data:form_values,type:this.options.type,id:this.options.id,onComplete:function(e){if(parent_comment_id==0&&postComment==1)
return;if(!en4.user.viewer.id)
advancedMenuUserLoginOrSignUp('login','','');if($('seaocore_edit_comment_'+comment_id))
$('seaocore_edit_comment_'+comment_id).style.display='none';if($('seaocore_comment_data-'+comment_id))
$('seaocore_comment_data-'+comment_id).style.display='block';if($('seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id))
$('seaocore_comment_image_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id).style.display='none';try{var replyCount=$$('.seaocore_replies_options span')[0];var m=replyCount.get('html').match(/\d+/);replyCount.set('html',replyCount.get('html').replace(m[0],e.commentsCount));}catch(e){}},onSuccess:function(responseJSON){if(!en4.user.viewer.id)
advancedMenuUserLoginOrSignUp('login','','');},onFailure:function(error){}}),{'force':true,'element':$('comments'+'_'+this.options.type+'_'+this.options.id+'_'+parent_comment_id)});return false;}}
this.fireEvent('editorKeyDown',e);},keyListener:function(e){},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}},_supportsContentEditable:function(){if('useContentEditable'in this.options&&this.options.useContentEditable){return true;}else{return false;}}});ComposerNestedComment.Selection=new Class({initialize:function(win){this.win=win;},getSelection:function(){return window.getSelection();},getRange:function(){var s=this.getSelection();if(!s)
return null;try{return s.rangeCount>0?s.getRangeAt(0):(s.createRange?s.createRange():null);}catch(e){return document.body.createTextRange();}},setRange:function(range){if(range.select){$try(function(){range.select();});}else{var s=this.getSelection();if(s.addRange){s.removeAllRanges();s.addRange(range);}}},selectNode:function(node,collapse){var r=this.getRange();var s=this.getSelection();if(r.moveToElementText){$try(function(){r.moveToElementText(node);r.select();});}else if(s.addRange){collapse?r.selectNodeContents(node):r.selectNode(node);s.removeAllRanges();s.addRange(r);}else{s.setBaseAndExtent(node,0,node,1);}
return node;},isCollapsed:function(){var r=this.getRange();if(r.item)
return false;return r.boundingWidth==0||this.getSelection().isCollapsed;},collapse:function(toStart){var r=this.getRange();var s=this.getSelection();if(r.select){r.collapse(toStart);r.select();}else{toStart?s.collapseToStart():s.collapseToEnd();}},getContent:function(){var r=this.getRange();var body=new Element('body');if(this.isCollapsed())
return'';if(r.cloneContents){body.appendChild(r.cloneContents());}else if($defined(r.item)||$defined(r.htmlText)){body.set('html',r.item?r.item(0).outerHTML:r.htmlText);}else{body.set('html',r.toString());}
var content=body.get('html');return content;},getText:function(){var r=this.getRange();var s=this.getSelection();return this.isCollapsed()?'':r.text||s.toString();},getNode:function(){var r=this.getRange();if(!Browser.Engine.trident){var el=null;if(r){el=r.commonAncestorContainer;if(!r.collapsed)
if(r.startContainer==r.endContainer)
if(r.startOffset-r.endOffset<2)
if(r.startContainer.hasChildNodes())
el=r.startContainer.childNodes[r.startOffset];while($type(el)!='element')
el=el.parentNode;}
return $(el);}
return $(r.item?r.item(0):r.parentElement());},insertContent:function(content){var r=this.getRange();if(r.insertNode){r.deleteContents();r.insertNode(r.createContextualFragment(content));}else{(r.pasteHTML)?r.pasteHTML(content):r.item(0).outerHTML=content;}}});ComposerNestedComment.OverText=new Class({Extends:OverText,test:function(){var v;if(!$type(this.options.isPlainText)||!this.options.isPlainText){v=this.element.get('html').replace(/\s+/,'').replace(/<br.*?>/,'');}else{v=!this.parent();}
return!v;},hide:function(suppressFocus,force){if(this.text&&(this.text.isDisplayed()&&(!this.element.get('disabled')||force))){this.text.hide();this.fireEvent('textHide',[this.text,this.element]);this.pollingPaused=true;try{this.element.fireEvent('focus');this.element.focus();if(composeInstanceComment.getContent()){(function(){var range=document.createRange();var sel=window.getSelection();range.setStart(this.element,1);range.collapse(true);sel.removeAllRanges();sel.addRange(range);this.element.focus();}).bind(this).delay(10);}}catch(e){}}
return this;}})
ComposerNestedComment.Plugin={};ComposerNestedComment.Plugin.Interface=new Class({Implements:[Options,Events],name:'interface',active:false,composer:false,options:{loadingImage:en4.core.staticBaseUrl+'application/modules/Seaocore/externals/images/core/loading.gif'},elements:{},persistentElements:['activator','loadingImage'],params:{},initialize:function(options){this.params=new Hash();this.elements=new Hash();this.reset();this.setOptions(options);},getName:function(){return this.name;},setComposer:function(composer){this.composer=composer;this.attach();return this;},getComposer:function(){if(!this.composer)
throw"No composer defined";return this.composer;},attach:function(){this.reset();},detach:function(){this.reset();if(this.elements.activator){this.elements.activator.destroy();this.elements.erase('menu');}},reset:function(){this.elements.each(function(element,key){if($type(element)=='element'&&!this.persistentElements.contains(key)){element.destroy();this.elements.erase(key);}}.bind(this));this.params=new Hash();this.elements=new Hash();},activate:function(){if(this.active)
return;this.active=true;this.reset();this.getComposer().getTray().setStyle('display','');this.getComposer().getMenu().setStyle('display','none');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','none');}
this.getComposer().getMenu().setStyle('border','none');this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','none');});switch($type(this.options.loadingImage)){case'element':break;case'string':this.elements.loadingImage=new Asset.image(this.options.loadingImage,{'id':'nested-compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;default:this.elements.loadingImage=new Asset.image('loading.gif',{'id':'nested-compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;}},deactivate:function(){if(!this.active)
return;this.active=false;this.reset();this.getComposer().getTray().setStyle('display','');this.getComposer().getMenu().setStyle('display','');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','');}
this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','');});this.getComposer().getMenu().set('style','');this.getComposer().signalPluginReady(false);},ready:function(){this.getComposer().signalPluginReady(true);this.getComposer().getMenu().setStyle('display','');var submitEl=$(this.getComposer().options.submitElement);if(submitEl){submitEl.setStyle('display','');}},makeActivator:function(){if(!this.elements.activator){this.elements.activator=new Element('a',{'id':'nested-comment-compose-'+this.getName()+'-activator','class':'compose-activator buttonlink','href':'javascript:void(0);','html':this._lang(this.options.title),'title':this._lang(this.options.title),'events':{'click':this.activate.bind(this)}}).inject(this.getComposer().getMenu());if(nestedCommentPressEnter==0||nestedCommentPressEnter==''){this.elements.activator.inject($("composer_container_icons_"+this.getComposer().getForm().get('action-id')));}
return false;}},makeMenu:function(){if(!this.elements.menu){var tray=this.getComposer().getTray();this.elements.menu=new Element('div',{'id':'nested-compose-'+this.getName()+'-menu','class':'compose-menu'}).inject(tray);this.elements.menuTitle=new Element('span',{'html':this._lang(this.options.title)+' ('}).inject(this.elements.menu);this.elements.menuClose=new Element('a',{'href':'javascript:void(0);','html':this._lang('cancel'),'events':{'click':function(e){e.stop();this.getComposer().deactivate();}.bind(this)}}).inject(this.elements.menuTitle);this.elements.menuTitle.appendText(')');}},makeBody:function(){if(!this.elements.body){var tray=this.getComposer().getTray();this.elements.body=new Element('div',{'id':'nested-compose-'+this.getName()+'-body','class':'compose-body'}).inject(tray);}},makeLoading:function(action){if(!this.elements.loading){if(action=='empty'){this.elements.body.empty();}else if(action=='hide'){this.elements.body.getChildren().each(function(element){element.setStyle('display','none')});}else if(action=='invisible'){this.elements.body.getChildren().each(function(element){element.setStyle('height','0px').setStyle('visibility','hidden')});}
this.elements.loading=new Element('div',{'id':'nested-compose-'+this.getName()+'-loading','class':'compose-loading'}).inject(this.elements.body);var image=this.elements.loadingImage||(new Element('img',{'id':'nested-compose-'+this.getName()+'-loading-image','class':'compose-loading-image'}));image.inject(this.elements.loading);new Element('span',{'html':this._lang('Loading...')}).inject(this.elements.loading);}},makeError:function(message,action){if(!$type(action))
action='empty';message=message||'An error has occurred';message=this._lang(message);this.elements.error=new Element('div',{'id':'nested-compose-'+this.getName()+'-error','class':'compose-error','html':message}).inject(this.elements.body);},makeFormInputs:function(data){this.ready();this.getComposer().getInputArea().empty();data.type=this.getName();$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){var elName='attachmentForm'+key.capitalize();if(!this.elements.has(elName)){this.elements.set(elName,new Element('input',{'type':'hidden','name':'attachment['+key+']','value':value||''}).inject(this.getComposer().getInputArea()));}
this.elements.get(elName).value=value;},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}}});})();;(function(){var $='id'in document?document.id:window.$;ComposerNestedActivityComment=new Class({Implements:[Events,Options],elements:{},plugins:{},options:{lang:{},overText:true,allowEmptyWithoutAttachment:false,allowEmptyWithAttachment:true,hideSubmitOnBlur:true,submitElement:false,useContentEditable:true},initialize:function(element,options){this.setOptions(options);this.elements=new Hash(this.elements);this.plugins=new Hash(this.plugins);this.elements.textarea=$(element);this.elements.textarea.store('Composer');this.attach();this.pluginReady=false;this.getForm().addEvent('submit',function(e){if(this.pluginReady){if(!this.options.allowEmptyWithAttachment&&this.getContent()==''){e.stop();return;}}else{if(!this.options.allowEmptyWithoutAttachment&&this.getContent()==''){e.stop();return;}}
this.saveContent();}.bind(this));},getMenu:function(){if(!$type(this.elements.menu)){this.elements.menu=$try(function(){return $(this.options.menuElement);}.bind(this));if(!$type(this.elements.menu)){this.elements.menu=new Element('div',{'id':'compose-menu','class':'compose-menu'}).inject(this.getForm());}}
return this.elements.menu;},getTray:function(){if(!$type(this.elements.tray)){this.elements.tray=$try(function(){return $(this.options.trayElement);}.bind(this));if(!$type(this.elements.tray)){this.elements.tray=new Element('div',{'id':'compose-tray','class':'compose-tray','styles':{'display':'none'}}).inject(this.getForm());}}
return this.elements.tray;},getInputArea:function(){if(!$type(this.elements.inputarea)){var form=this.elements.textarea.getParent('form');this.elements.inputarea=new Element('div',{'styles':{'display':'none'}}).inject(form);}
return this.elements.inputarea;},getForm:function(){return this.elements.textarea.getParent('form');},attach:function(){var size=this.elements.textarea.getSize();this.elements.textarea.addClass('compose-textarea').setStyle('display','none');this.elements.container=new Element('div',{'id':'compose-container','class':'compose-container','styles':{}});this.elements.container.wraps(this.elements.textarea);var supportsContentEditable=this._supportsContentEditable();if(supportsContentEditable){this.elements.body=new Element('div',{'class':'compose-content','styles':{'display':'block'},'events':{'keypress':function(event){if(event.key=='a'&&event.control){if(Browser.Engine.gecko){fix_gecko_select_all_contenteditable_bug(this,event);}}}}}).inject(this.elements.textarea,'before');}else{this.elements.body=this.elements.textarea;}
var self=this;this.elements.body.addEvent('blur',function(e){var curVal;if(supportsContentEditable){curVal=this.get('html').replace(/\s/,'').replace(/<[^<>]+?>/ig,'');}else{curVal=this.get('value').replace(/\s/,'').replace(/<[^<>]+?>/ig,'')}
if(''==curVal){if(!Browser.Engine.trident){if(supportsContentEditable){this.set('html','<br />');}else{this.set('value','');}}
if(self.options.hideSubmitOnBlur){(function(){if(!self.hasActivePlugin()){self.getMenu().setStyle('display','none');}}).delay(250);}}});if(self.options.hideSubmitOnBlur){this.getMenu().setStyle('display','none');this.elements.body.addEvent('focus',function(e){self.getMenu().setStyle('display','');});}
if(supportsContentEditable){$(this.elements.body);this.elements.body.contentEditable=true;this.elements.body.designMode='On';['MouseUp','MouseDown','ContextMenu','Click','Dblclick','KeyPress','KeyUp','KeyDown'].each(function(eventName){var method=(this['editor'+eventName]||function(){}).bind(this);this.elements.body.addEvent(eventName.toLowerCase(),method);}.bind(this));this.setContent(this.elements.textarea.value);this.selection=new ComposerNestedActivityComment.Selection(this.elements.body);}else{this.elements.textarea.setStyle('display','');}
if(this.options.overText&&supportsContentEditable){new ComposerNestedActivityComment.OverText(this.elements.body,$merge({textOverride:this._lang('Post Something...'),poll:true,isPlainText:!supportsContentEditable,positionOptions:{position:(en4.orientation=='rtl'?'upperRight':'upperLeft'),edge:(en4.orientation=='rtl'?'upperRight':'upperLeft'),offset:{x:(en4.orientation=='rtl'?-4:4),y:2}}},this.options.overTextOptions));}
(function(){this.elements.body.focus();this.fireEvent('focus',this);}).bind(this).delay(10);this.fireEvent('attach',this);},detach:function(){this.saveContent();this.textarea.setStyle('display','').removeClass('compose-textarea').inject(this.container,'before');this.container.dispose();this.fireEvent('detach',this);return this;},focus:function(){(function(){this.elements.body.focus();this.fireEvent('focus',this);if(this.elements.body.get('html')){(function(){var parent=this.elements.body.getParent();var ele=parent.firstChild;var range=document.createRange();var sel=window.getSelection();range.setStart(ele,1);range.collapse(true);sel.removeAllRanges();sel.addRange(range);ele.focus();}).bind(this).delay(10);}}).bind(this).delay(10);return this;},getContent:function(){if(this._supportsContentEditable()){return this.cleanup(this.elements.body.get('html'));}else{return this.cleanup(this.elements.body.get('value'));}},setContent:function(newContent){if(this._supportsContentEditable()){if(!newContent.trim()&&!Browser.Engine.trident)newContent='<br />';this.elements.body.set('html',newContent);}else{this.elements.body.set('value',newContent);}
return this;},saveContent:function(){if(this._supportsContentEditable()){this.elements.textarea.set('value',this.getContent());}
return this;},cleanup:function(html){return html.replace(/<(br|p|div)[^<>]*?>/ig,"\r\n").replace(/<[^<>]+?>/ig,' ').replace(/(\r\n?|\n){3,}/ig,"\n\n").trim();},addPlugin:function(plugin){var key=plugin.getName();this.plugins.set(key,plugin);plugin.setComposer(this);return this;},addPlugins:function(plugins){plugins.each(function(plugin){this.addPlugin(plugin);}.bind(this));},getPlugin:function(name){return this.plugins.get(name);},activate:function(name){this.deactivate();this.getMenu().setStyle();this.plugins.get(name).activate();},deactivate:function(){this.plugins.each(function(plugin){plugin.deactivate();});this.getTray().empty();},signalPluginReady:function(state){this.pluginReady=state;},hasActivePlugin:function(){var active=false;this.plugins.each(function(plugin){active=active||plugin.active;});return active;},editorMouseUp:function(e){this.fireEvent('editorMouseUp',e);},editorMouseDown:function(e){this.fireEvent('editorMouseDown',e);},editorContextMenu:function(e){this.fireEvent('editorContextMenu',e);},editorClick:function(e){if(Browser.Engine.webkit){var el=e.target;if(el.get('tag')=='img'){this.selection.selectNode(el);}}
this.fireEvent('editorClick',e);},editorDoubleClick:function(e){this.fireEvent('editorDoubleClick',e);},editorKeyPress:function(e){this.keyListener(e);this.fireEvent('editorKeyPress',e);},editorKeyUp:function(e){if(e.key=='esc'){if(this.getForm().action_id.value&&this.getForm().comment_id&&this.getForm().comment_id.value){this.getForm().style.display='none';}
if(this.getForm().comment_id&&this.getForm().comment_id.value){if($('comments_body_'+this.getForm().comment_id.value)){$('comments_body_'+this.getForm().comment_id.value).style.display='inline-block';}
if($('comment_edit_'+this.getForm().comment_id.value)){$('comment_edit_'+this.getForm().comment_id.value).style.display='none';}}
if(this.getForm().comment_id&&this.getForm().comment_id.value){if($('reply_body_'+this.getForm().comment_id.value)){$('reply_body_'+this.getForm().comment_id.value).style.display='inline-block';}
if($('reply_edit_'+this.getForm().comment_id.value)){$('reply_edit_'+this.getForm().comment_id.value).style.display='none';}}}
this.fireEvent('editorKeyUp',e);},editorKeyDown:function(e){if(e.key=='enter'){}
this.fireEvent('editorKeyDown',e);},keyListener:function(e){},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}},_supportsContentEditable:function(){if('useContentEditable'in this.options&&this.options.useContentEditable&&!en4.isMobile){return true;}else{return false;}}});ComposerNestedActivityComment.Selection=new Class({initialize:function(win){this.win=win;},getSelection:function(){return window.getSelection();},getRange:function(){var s=this.getSelection();if(!s)return null;try{return s.rangeCount>0?s.getRangeAt(0):(s.createRange?s.createRange():null);}catch(e){return document.body.createTextRange();}},setRange:function(range){if(range.select){$try(function(){range.select();});}else{var s=this.getSelection();if(s.addRange){s.removeAllRanges();s.addRange(range);}}},selectNode:function(node,collapse){var r=this.getRange();var s=this.getSelection();if(r.moveToElementText){$try(function(){r.moveToElementText(node);r.select();});}else if(s.addRange){collapse?r.selectNodeContents(node):r.selectNode(node);s.removeAllRanges();s.addRange(r);}else{s.setBaseAndExtent(node,0,node,1);}
return node;},isCollapsed:function(){var r=this.getRange();if(r.item)return false;return r.boundingWidth==0||this.getSelection().isCollapsed;},collapse:function(toStart){var r=this.getRange();var s=this.getSelection();if(r.select){r.collapse(toStart);r.select();}else{toStart?s.collapseToStart():s.collapseToEnd();}},getContent:function(){var r=this.getRange();var body=new Element('body');if(this.isCollapsed())return'';if(r.cloneContents){body.appendChild(r.cloneContents());}else if($defined(r.item)||$defined(r.htmlText)){body.set('html',r.item?r.item(0).outerHTML:r.htmlText);}else{body.set('html',r.toString());}
var content=body.get('html');return content;},getText:function(){var r=this.getRange();var s=this.getSelection();return this.isCollapsed()?'':r.text||s.toString();},getNode:function(){var r=this.getRange();if(!Browser.Engine.trident){var el=null;if(r){el=r.commonAncestorContainer;if(!r.collapsed)
if(r.startContainer==r.endContainer)
if(r.startOffset-r.endOffset<2)
if(r.startContainer.hasChildNodes())
el=r.startContainer.childNodes[r.startOffset];while($type(el)!='element')el=el.parentNode;}
return $(el);}
return $(r.item?r.item(0):r.parentElement());},insertContent:function(content){var r=this.getRange();if(r.insertNode){r.deleteContents();r.insertNode(r.createContextualFragment(content));}else{(r.pasteHTML)?r.pasteHTML(content):r.item(0).outerHTML=content;}}});ComposerNestedActivityComment.OverText=new Class({Extends:OverText,test:function(){if(!$type(this.options.isPlainText)||!this.options.isPlainText){return!this.element.get('html').replace(/\s+/,'').replace(/<br.*?>/,'');}else{return this.parent();}},hide:function(suppressFocus,force){if(this.text&&(this.text.isDisplayed()&&(!this.element.get('disabled')||force))){this.text.hide();this.fireEvent('textHide',[this.text,this.element]);this.pollingPaused=true;try{this.element.fireEvent('focus');this.element.focus();}catch(e){}}
return this;}})
ComposerNestedActivityComment.Plugin={};ComposerNestedActivityComment.Plugin.Interface=new Class({Implements:[Options,Events],name:'interface',active:false,composer:false,options:{loadingImage:en4.core.staticBaseUrl+'application/modules/Seaocore/externals/images/core/loading.gif'},elements:{},persistentElements:['activator','loadingImage'],params:{},initialize:function(options){this.params=new Hash();this.elements=new Hash();this.reset();this.setOptions(options);},getName:function(){return this.name;},setComposer:function(composer){this.composer=composer;this.attach();return this;},getComposer:function(){if(!this.composer)throw"No composer defined";return this.composer;},attach:function(){this.reset();},detach:function(){this.reset();if(this.elements.activator){this.elements.activator.destroy();this.elements.erase('menu');}},reset:function(){this.elements.each(function(element,key){if($type(element)=='element'&&!this.persistentElements.contains(key)){element.destroy();this.elements.erase(key);}}.bind(this));this.params=new Hash();this.elements=new Hash();},activate:function(){if(this.active)return;this.active=true;this.reset();this.getComposer().getTray().setStyle('display','');this.getComposer().getMenu().setStyle('display','none');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','none');}
this.getComposer().getMenu().setStyle('border','none');this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','none');});if($('compose-photo-form-fancy-file')){$('compose-photo-form-fancy-file').addClass('dnone');}
switch($type(this.options.loadingImage)){case'element':break;case'string':this.elements.loadingImage=new Asset.image(this.options.loadingImage,{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;default:this.elements.loadingImage=new Asset.image('loading.gif',{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'});break;}},deactivate:function(){if(!this.active)return;this.active=false;this.reset();if($('compose-photo-form-fancy-file')){$('compose-photo-form-fancy-file').removeClass('dnone');}
this.getComposer().getTray().setStyle('display','none');this.getComposer().getMenu().setStyle('display','');var submitButtonEl=$(this.getComposer().options.submitElement);if(submitButtonEl){submitButtonEl.setStyle('display','');}
this.getComposer().getMenu().getElements('.compose-activator').each(function(element){element.setStyle('display','');});this.getComposer().getMenu().set('style','');this.getComposer().signalPluginReady(false);},ready:function(){this.getComposer().signalPluginReady(true);this.getComposer().getMenu().setStyle('display','');var submitEl=$(this.getComposer().options.submitElement);if(submitEl){submitEl.setStyle('display','');}},makeActivator:function(){if(!this.elements.activator){this.elements.activator=new Element('a',{'id':'compose-'+this.getName()+'-activator','class':'compose-activator menu_index_'+this.options.menuIndex,'href':'javascript:void(0);','title':this._lang(this.options.title),'events':{'click':this.activate.bind(this)}}).inject(this.getComposer().getMenu());}},makeMenu:function(){if(!this.elements.menu){var tray=this.getComposer().getTray();this.elements.menu=new Element('div',{'id':'compose-'+this.getName()+'-menu','class':'compose-menu'}).inject(tray);this.elements.menuTitle=new Element('span',{'html':this._lang(this.options.title)+' ('}).inject(this.elements.menu);this.elements.menuClose=new Element('a',{'href':'javascript:void(0);','html':this._lang('cancel'),'events':{'click':function(e){e.stop();this.getComposer().deactivate();}.bind(this)}}).inject(this.elements.menuTitle);this.elements.menuTitle.appendText(')');}},makeBody:function(){if(!this.elements.body){var tray=this.getComposer().getTray();this.elements.body=new Element('div',{'id':'compose-'+this.getName()+'-body','class':'compose-body'}).inject(tray);}},makeLoading:function(action){if(!this.elements.loading){if(action=='empty'){this.elements.body.empty();}else if(action=='hide'){this.elements.body.getChildren().each(function(element){element.setStyle('display','none')});}else if(action=='invisible'){this.elements.body.getChildren().each(function(element){element.setStyle('height','0px').setStyle('visibility','hidden')});}
this.elements.loading=new Element('div',{'id':'compose-'+this.getName()+'-loading','class':'compose-loading'}).inject(this.elements.body);var image=this.elements.loadingImage||(new Element('img',{'id':'compose-'+this.getName()+'-loading-image','class':'compose-loading-image'}));image.inject(this.elements.loading);new Element('span',{'html':this._lang('Loading...')}).inject(this.elements.loading);}},makeError:function(message,action){if(!$type(action))action='empty';message=message||'An error has occurred';message=this._lang(message);this.elements.error=new Element('div',{'id':'compose-'+this.getName()+'-error','class':'compose-error','html':message}).inject(this.elements.body);},makeFormInputs:function(data){this.ready();this.getComposer().getInputArea().empty();data.type=this.getName();$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){var elName='attachmentForm'+key.capitalize();if(!this.elements.has(elName)){this.elements.set(elName,new Element('input',{'type':'hidden','id':key,'name':'attachment['+key+']','value':value||''}).inject(this.getComposer().getInputArea()));}
this.elements.get(elName).value=value;},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}}});})();;(function(){var $='id'in document?document.id:window.$;en4.activity={load:function(next_id,subject_guid){if(en4.core.request.isRequestActive())return;$('feed_viewmore').style.display='none';$('feed_loading').style.display='';en4.core.request.send(new Request.HTML({url:en4.core.baseUrl+'activity/widget/feed',data:{'maxid':next_id,'feedOnly':true,'nolayout':true,'subject':subject_guid}}),{'element':$('activity-feed'),'updateHtmlMode':'append'});},like:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/like',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},unlike:function(action_id,comment_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/unlike',data:{format:'json',action_id:action_id,comment_id:comment_id,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},comment:function(action_id,body){if(body.trim()=='')
{return;}
en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/comment',data:{format:'json',action_id:action_id,body:body,subject:en4.core.subject.guid}}),{'element':$('comment-likes-activity-item-'+action_id),'updateHtmlMode':'comments2'});},attachComment:function(formElement){var bind=this;formElement.addEvent('submit',function(event){event.stop();bind.comment(formElement.action_id.value,formElement.body.value);});},viewComments:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewComment',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},viewLikes:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/index/viewLike',data:{format:'json',action_id:action_id,nolist:true}}),{'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});},hideNotifications:function(reset_text){en4.core.request.send(new Request.JSON({'url':en4.core.baseUrl+'activity/notifications/hide'}));$('updates_toggle').set('html',reset_text).removeClass('new_updates');$('update_count').removeClass('minimenu_update_count_bubble_active');if($('notifications_main')){var notification_children=$('notifications_main').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}
if($('notifications_menu')){var notification_children=$('notifications_menu').getChildren('li');notification_children.each(function(el){el.setAttribute('class','');});}},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');}},markRead:function(action_id){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/test',data:{format:'json','actionid':action_id}}));},cometNotify:function(responseObject){$('core_menu_mini_menu_updates').style.display='';$('core_menu_mini_menu_updates_count').innerHTML=responseObject.text;},post:function(composeInstance,event){event.stop();var formData=composeInstance.getForm().toQueryString().parseQueryString();en4.core.request.send(new Request.JSON({url:composeInstance.getForm().get('action'),data:formData,format:'json',onComplete:function(resp){if(!resp.status){$('fail_msg').style.display="block";return;}
if(!$('activity-feed')){new Element('ul',{'id':'activity-feed','class':'feed'}).inject(document.getElement('.layout_activity_feed').getElementById('fail_msg'),'after');$('no-feed-tip').destroy();}
window._activityUpdateHandler.options.next_id=resp.action_id;window._activityUpdateHandler.getFeedUpdate(window._activityUpdateHandler.options.next_id,true);$('token').value=resp.formToken;composeInstance.plugins.each(function(plugin){plugin.reset();});composeInstance.reset();}}),{force:true,});},bindEditFeed:function(action_id,composerOptions){if($('activity-item-'+action_id).getElement('.compose-container')){return;}
var editComposeInstance=new Composer('feed-edit-body-'+action_id,{lang:composerOptions.lang,hideSubmitOnBlur:false,allowEmptyWithoutAttachment:composerOptions.allowEmptyWithoutAttachment,submitCallBack:function(composeInstance,event){event.stop();var params=composeInstance.getForm().toQueryString().parseQueryString();en4.core.request.send(new Request.JSON({url:editComposeInstance.getForm().get('action'),data:$merge({format:'json',subject:en4.core.subject.guid},params),method:'POST',onRequest:function(){editComposeInstance.getForm().getElementById('fieldset-buttons').setStyle('display','none');en4.core.loader.inject(editComposeInstance.getForm().getElementById('buttons-wrapper'));}}),{'force':true,'element':$('activity-item-'+action_id),'updateHtmlMode':'comments'});}});if(editComposeInstance._supportsContentEditable()){editComposeInstance.setContent(editComposeInstance.elements.body.get('html').replace(/(\r\n?|\n)/ig,"<br>"));}
document.store('editComposeInstanceActivity'+action_id,editComposeInstance);this.bindEditLink(action_id);$('activity-item-'+action_id).getElement('.feed-edit-content-cancel').addEvent('click',function(event){var el=$(event.target);var parent=el.getParent('.activity-item');parent.getElement('.feed_item_body_edit_content').setStyle('display','none');parent.getElement('.feed_item_body_content').setStyle('display','block');});},bindEditLink:function(action_id){if(!$('activity-item-'+action_id).getElement('.feed_item_option_edit')){return;}
$('activity-item-'+action_id).getElement('.feed_item_option_edit').addEvent('click',function(event){var el=$(event.target);var parent=el.getParent('.activity-item');parent.getElement('.feed_item_body_content').setStyle('display','none');parent.getElement('.feed_item_body_edit_content').setStyle('display','block');});}};NotificationUpdateHandler=new Class({Implements:[Events,Options],options:{debug:false,baseUrl:'/',identity:false,delay:5000,minDelay:5000,maxDelay:600000,delayFactor:1.5,admin:false,idleTimeout:600000,last_id:0,subject_guid:null},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);this.options.minDelay=this.options.delay;},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},updateNotifications:function(){if(en4.core.request.isRequestActive())return;en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/update',data:{format:'json'},onSuccess:this.showNotifications.bind(this)}));},showNotifications:function(responseJSON){if(responseJSON.notificationCount>0){this.options.delay=this.options.minDelay;$('updates_toggle').set('html',responseJSON.text).addClass('new_updates');$('update_count').set('html',responseJSON.notificationCount).addClass('minimenu_update_count_bubble_active');}else{this.options.delay=Math.min(this.options.maxDelay,this.options.delayFactor*this.options.delay);}},loop:function(){if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.updateNotifications().addEvent('complete',function(){this.loop.delay(this.options.delay,this);}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}},_log:function(object){if(!this.options.debug){return;}
try{if(typeof(console)&&$type(console)){console.log(object);}}catch(e){}}});en4.activity.compose={composers:{},register:function(object){name=object.getName();this.composers[name]=object;},deactivate:function(){for(var x in this.composers){this.composers[x].deactivate();}
return this;}};en4.activity.compose.icompose=new Class({Implements:[Events,Options],name:false,element:false,options:{},initialize:function(element,options){this.element=$(element);this.setOptions(options);},getName:function(){return this.name;},activate:function(){en4.activity.compose.deactivate();},deactivate:function(){}});ActivityUpdateHandler=new Class({Implements:[Events,Options],options:{debug:true,baseUrl:'/',identity:false,delay:5000,admin:false,idleTimeout:600000,last_id:0,next_id:null,subject_guid:null,showImmediately:false},state:true,activestate:1,fresh:true,lastEventTime:false,title:document.title,initialize:function(options){this.setOptions(options);},start:function(){this.state=true;this.idleWatcher=new IdleWatcher(this,{timeout:this.options.idleTimeout});this.idleWatcher.register();this.addEvents({'onStateActive':function(){this._log('activity loop onStateActive');this.activestate=1;this.state=true;}.bind(this),'onStateIdle':function(){this._log('activity loop onStateIdle');this.activestate=0;this.state=false;}.bind(this)});this.loop();},stop:function(){this.state=false;},checkFeedUpdate:function(action_id,subject_guid){if(en4.core.request.isRequestActive())return;function getAllElementsWithAttribute(attribute){var matchingElements=[];var values=[];var allElements=document.getElementsByTagName('*');for(var i=0;i<allElements.length;i++){if(allElements[i].getAttribute(attribute)){matchingElements.push(allElements[i]);values.push(allElements[i].getAttribute(attribute));}}
return values;}
var list=getAllElementsWithAttribute('data-activity-feed-item');this.options.last_id=Math.max.apply(Math,list);min_id=parseInt(this.options.last_id)+1;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'subject':this.options.subject_guid,'getUpdate':true}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend'});req.addEvent('complete',function(){(function(){if(this.options.showImmediately&&$('feed-update').getChildren().length>0){$('feed-update').setStyle('display','none');$('feed-update').empty();this.getFeedUpdate(this.options.next_id);}}).delay(50,this);}.bind(this));if(localStorage){var pageTitle=document.title;var feed=document.getElementById('activity-feed');var items=feed.getElementsByTagName("li");var itemObject={};var c=0;for(var i=0;i<items.length;++i){if(items[i].getAttribute('data-activity-feed-item')!=null){var itemId=items[i].getAttribute('data-activity-feed-item');itemObject[c]={id:itemId,content:document.getElementById('activity-item-'+itemId).innerHTML};c++;}}
var activityFeedJSON=JSON.stringify(itemObject);localStorage.setItem(pageTitle+'-activity-feed-widget',activityFeedJSON);}
if(localStorage.getItem(pageTitle+'-activity-feed-widget')){var storedFeedJSON=localStorage.getItem(pageTitle+'-activity-feed-widget');var storedObj=eval("("+storedFeedJSON+")");}
return req;},getFeedUpdate:function(last_id,force){if(!force&&en4.core.request.isRequestActive())return;var min_id=parseInt(this.options.last_id)+1;this.options.last_id=last_id;document.title=this.title;var req=new Request.HTML({url:en4.core.baseUrl+'widget/index/name/activity.feed',data:{'format':'html','minid':min_id,'feedOnly':true,'nolayout':true,'getUpdate':true,'subject':this.options.subject_guid}});en4.core.request.send(req,{'element':$('activity-feed'),'updateHtmlMode':'prepend',force:!!force});return req;},loop:function(){this._log('activity update loop start');if(!this.state){this.loop.delay(this.options.delay,this);return;}
try{this.checkFeedUpdate().addEvent('complete',function(){try{this._log('activity loop req complete');this.loop.delay(this.options.delay,this);}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}}.bind(this));}catch(e){this.loop.delay(this.options.delay,this);this._log(e);}
this._log('activity update loop stop');},_log:function(object){if(!this.options.debug){return;}
try{if('console'in window&&typeof(console)&&'log'in console){console.log(object);}}catch(e){}}});})();;var showNotifications;window.addEvent('domready',function(){showNotifications=function(){en4.activity.updateNotifications();new Request.HTML({'url':en4.core.baseUrl+'advancedactivity/notifications/pulldown','data':{'format':'html','page':1},'onComplete':function(responseTree,responseElements,responseHTML,responseJavaScript){if(responseHTML){if($('notifications_loading'))
$('notifications_loading').setStyle('display','none');$('notifications_menu').innerHTML=responseHTML;$('notifications_menu').addEvent('click',function(event){event.stop();var current_link=event.target;var notification_li=$(current_link).getParent('li');if(notification_li.id=='core_menu_mini_menu_update'){notification_li=current_link;}
var forward_link;if(current_link.get('href')){forward_link=current_link.get('href');}else{forward_link=$(current_link).getElements('a:last-child').get('href');if(forward_link==''||$(current_link).get('tag')=='img'){var a_el=$(current_link).getParent('a');if(a_el)
forward_link=$(current_link).getParent('a').get('href');}
if(forward_link==''||$(current_link).get('tag')=='span'){forward_link=$(notification_li).getElements('a:last-child').get('href');}}
var notifications_unread=false;if(notification_li.get('class')){notification_li.get('class').split(' ').each(function(className){className=className.trim();if(className=='notifications_unread')
notifications_unread=true;});}
if(notifications_unread){notification_li.removeClass('notifications_unread');en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/markread',data:{format:'json','actionid':notification_li.get('value')},onSuccess:function(){window.location=forward_link;}}));}else{window.location=forward_link;}});}else{$('notifications_loading').innerHTML=en4.core.language.translate("You have no new updates.");}}}).send();};});window.addEvent('domready',function(){if($('notifications_menu')){$('notifications_menu').addEvent('click',function(event){event.stop();notificationClick(event);});}});function notificationClick(event)
{var current_link=event.target;var notification_li=$(current_link).getParent('li');var forward_link;if(current_link.get('href')){forward_link=current_link.get('href');}else{forward_link=$(current_link).getElements('a:last-child').get('href');if(forward_link==''||$(current_link).get('tag')=='img'){var a_el=$(current_link).getParent('a');if(a_el)
forward_link=$(current_link).getParent('a').get('href');}
if(forward_link==''||$(current_link).get('tag')=='span'){forward_link=$(notification_li).getElements('a:last-child').get('href');}}
if(forward_link){en4.core.request.send(new Request.JSON({url:en4.core.baseUrl+'activity/notifications/markread',data:{format:'json','actionid':notification_li.get('value')},onSuccess:function(){window.location=forward_link;}}));}}