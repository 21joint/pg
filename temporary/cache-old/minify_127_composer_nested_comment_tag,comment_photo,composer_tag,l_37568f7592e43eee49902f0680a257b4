ComposerNestedActivityComment.Plugin.Tag=new Class({Extends:ComposerNestedActivityComment.Plugin.Interface,name:'tag',options:{'enabled':false,requestOptions:{},'suggestOptions':{'minLength':0,'maxChoices':100,'delay':250,'selectMode':'pick','multiple':false,'filterSubset':true,'tokenFormat':'object','tokenValueKey':'label','injectChoice':$empty,'onPush':$empty,'prefetchOnInit':true,'alwaysOpen':false,'ignoreKeys':true,'stopKeysEvent':false}},initialize:function(options){this.params=new Hash(this.params);this.parent(options);},suggest:false,attach:function(){this.parent();var self=this;this.getComposer().addEvent((1)?'editorKeyDown':'editorKeyPress',function(event){if(self.suggest&&self.suggest.visible&&event){self.suggest.onCommand(event);if(self.suggest.stopKeysEvent){event.stop();return;}}
self.monitor.bind(self)(event);});this.getComposer().addEvent('editorClick',this.monitor.bind(this));this.getComposer().addEvent('editorSubmit',this.submit.bind(this));return this;},detach:function(){if(!this.options.enabled)
return;this.parent();this.getComposer().removeEvent('editorKeyPress',this.monitor.bind(this));this.getComposer().removeEvent('editorClick',this.monitor.bind(this));this.getComposer().removeEvent('editorSubmit',this.submit.bind(this));if(this.interval)
$clear(this.interval);return this;},activate:$empty,deactivate:$empty,poll:function(){},monitor:function(e){(function(){var selection=this.getComposer().selection;var range=selection.getRange();if(!range)
return;var start=0;if(window.getSelection){start=range.startOffset;}else if(document.selection){var range_t=document.selection.createRange();if(range_t==null||range_t['text']==null){}else{var textlength=selection.win.innerText.length;range.moveStart("character",-textlength);start=range.text.length;}}
var content=null;if(range.startContainer){content=range.startContainer.data;}else if(selection.win){content=selection.win.innerText;}
if(!content)
return;this.filterAAFTagsFromComposer();var currentIndex=false;content=content.substring(0,start);currentIndex=content.lastIndexOf('@');if(currentIndex==-1||currentIndex>=start||currentIndex+10<=start){this.endSuggest();return;}
var segment=content.substring(currentIndex+1,start);var spaceIndex=segment.indexOf(' ');if(spaceIndex>-1){if(currentIndex+spaceIndex<start){this.endSuggest();return;}else{segment=segment.substring(0,spaceIndex);}}
if(segment==''){this.endSuggest();return;}
this.doSuggest(segment);}).delay(5,this);},doSuggest:function(text){this.currentText=text;var suggest=this.getSuggest();var input=this.getHiddenInput();input.set('value',text);input.value=text;suggest.prefetch();},endSuggest:function(){this.currentText='';this.positions={};if(this.suggest){this.getSuggest().destroy();delete this.suggest;}},getHiddenInput:function(){if(!this.hiddenInput){this.hiddenInput=new Element('input',{'type':'text','styles':{'display':'none'}}).inject(document.body);}
return this.hiddenInput;},getSuggest:function(){if(!this.suggest){var width=this.getComposer().elements.body.getSize().x;this.choices=new Element('ul',{'class':'tag-autosuggest seaocore-autosuggest','styles':{'width':(width-2)+'px'}}).inject(this.getComposer().elements.body,'after');var self=this;var options=$merge(this.options.suggestOptions,{'customChoices':this.choices,'injectChoice':function(token){var choice=new Element('li',{'class':'autocompleter-choices','html':token.photo||'','id':token.guid});var divEl=new Element('div',{'html':this.markQueryValue(token.label),'class':'autocompleter-choice'});if(token.type!='user'){new Element('div',{'html':this.markQueryValue(token.type)}).inject(divEl);}
divEl.inject(choice);new Element('input',{'type':'hidden','value':JSON.encode(token)}).inject(choice);this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},'onChoiceSelect':function(choice){var data=JSON.decode(choice.getElement('input').value);var composer=self.getComposer();var body=composer.elements.body;var content=null;if(composer._supportsContentEditable()){content=composer.elements.body.get('html');}else{content=composer.elements.body.get('value');}
var replaceString='@'+self.currentText;var newString='<span class="aaf_feed_composer_tag" rel="'+data.guid+'" rev="'+data.label+'" >'+data.label+'</span>&nbsp;';content=content.replace(/\<span\>\<\/span\>/ig,'');content=content.replace(new RegExp(replaceString,'i'),newString);composer.setContent(content);var tagElement=self.getAAFTagElementFromComposer(data.label);if(window.getSelection){composer.selection.getSelection().collapse(tagElement.nextSibling,1);}else if(document.selection){composer.selection.getRange().moveToElementText(tagElement);}},'emptyChoices':function(){this.fireEvent('onHide',[this.element,this.choices]);},'onCommand':function(e){if(e&&e.key&&!e.shift){switch(e.key){case'enter':e.stop();if(!this.selected){if(!this.options.customChoices){this.element.value='';}
return true;}
if(this.selected&&this.visible){this.stopKeysEvent=true;this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){this.stopKeysEvent=true;var up=(e.key=='up');if(this.selected)
this.selected.removeClass('autocompleter-selected');if(!(this.selected)[((up)?'getPrevious':'getNext')](this.options.choicesMatch)){this.selected=null;}
this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.stopKeysEvent=true;this.hideChoices(true);if(!this.options.customChoices)
this.element.value='';break;case'tab':this.stopKeysEvent=true;if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)
this.element.value='';break;}
default:this.stopKeysEvent=false;}}}});if(this.options.suggestProto=='local'){this.suggest=new Autocompleter.Local(this.getHiddenInput(),this.options.suggestParam,options);}else if(this.options.suggestProto=='request.json'){this.suggest=new Autocompleter.Request.JSON(this.getHiddenInput(),this.options.suggestOptions.url,options);}
if(this.suggest&&!this.suggest.options.alwaysOpen){this.getComposer().elements.body.addEvent('blur',this.suggestHideChoices.create({bind:this}));}}
return this.suggest;},suggestHideChoices:function(){var suggest=this.suggest;if(suggest){suggest.hideChoices(true);if(!suggest.options.customChoices)
suggest.element.value='';}},filterAAFTagsFromComposer:function()
{var body=this.getComposer().elements.body;body.getElements('.aaf_feed_composer_tag').each(function(tag){if(tag.get('text')!=tag.get('rev')){tag.removeClass('aaf_feed_composer_tag');}});},getAAFTagElementFromComposer:function(text){var body=this.getComposer().elements.body;var element=null;body.getElements('.aaf_feed_composer_tag').each(function(tag){if(tag.get('text')==tag.get('rev')&&tag.get('text')==text.replace(/&#039;/ig,'\'')){element=tag;}});return element;},submit:function(){this.makeFormInputs({tag:this.getAAFTagsFromComposer().toQueryString()});},getAAFTagsFromComposer:function()
{this.filterAAFTagsFromComposer();var composerTags=new Hash();var body=this.getComposer().elements.body;body.getElements('.aaf_feed_composer_tag').each(function(tag){composerTags[tag.get('rel')]=tag.get('text');});return composerTags;},makeFormInputs:function(data){$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){var elName='aafComposerForm'+key.capitalize();var composerObj=this.getComposer();if(composerObj.elements.has(elName))
composerObj.elements.get(elName).destroy();composerObj.elements.set(elName,new Element('input',{'type':'hidden','name':'composer['+key+']','value':value||''}).inject(composerObj.getInputArea()));composerObj.elements.get(elName).value=value;}});;var commentAttachment={editComment:{}};var replyAttachment={editReply:{}};var commentPhoto=new Class({options:{title:'Add Photo',lang:{},requestOptions:false,fancyUploadEnabled:true,fancyUploadOptions:{}},initialize:function(){},activate:function(){},getPhotoContent:function(element,options){this.params=new Hash();this.elements=new Hash();this.reset();this.elements.textarea=$(element);this.makeMenu(0);this.makeBody();this.pluginReady=true;var fullUrl=options.requestOptions.url;this.elements.form=new Element('form',{'id':'compose-photo-form','class':'compose-form','method':'post','action':fullUrl,'enctype':'multipart/form-data'}).inject(this.elements.body);this.elements.form.setStyle('height','0px');this.elements.formInput=new Element('input',{'id':'compose-photo-form-input','class':'compose-form-input','type':'file','name':'Filedata','styles':{'opacity':0},'events':{'change':this.doRequest.bind(this)}}).inject(this.elements.form);this.elements.formFancyContainer=new Element('div',{'styles':{'display':'none','visibility':'hidden'}}).inject(this.elements.body);this.elements.preview_image=new Element('div',{'id':'nested_preview_image','styles':{'display':'none'}}).inject(this.elements.body);this.elements.formFancyFile=new Element('a',{'href':'javascript:void(0);','id':'compose-photo-form-fancy-file','class':'buttonlink','html':this._lang('Attach a Photo'),'title':this._lang('Attach a Photo')}).inject(this.elements.formFancyContainer);this.elements.formFancyStatus=new Element('div',{'html':'<div style="display:none;">\n\
  <div class="demo-status-overall" id="demo-status-overall" style="display:none;">\n\
    <div class="overall-title"></div>\n\
    <img src="" class="progress overall-progress" />\n\
  </div>\n\
  <div class="demo-status-current" id="demo-status-current" style="display:none;">\n\
    <div class="current-title"></div>\n\
    <img src="" class="progress current-progress" />\n\
  </div>\n\
  <div class="current-text"></div>\n\
</div>'}).inject(this.elements.formFancyContainer);this.elements.formFancyList=new Element('div',{'styles':{'display':'none'}}).inject(this.elements.formFancyContainer);var self=this;var opts=$merge({policyFile:('https:'==document.location.protocol?'https://':'http://')
+document.location.host
+en4.core.baseUrl+'cross-domain',url:options.fancyUploadOptions.url,appendCookieData:true,multiple:false,typeFilter:{'Images (*.jpg, *.jpeg, *.gif, *.png)':'*.jpg; *.jpeg; *.gif; *.png'},target:this.elements.formFancyFile,onLoad:function(){self.elements.formFancyContainer.setStyle('display','');self.elements.formFancyContainer.setStyle('visibility','visible');self.elements.form.destroy();this.target.addEvents({click:function(){return false;},mouseenter:function(){this.addClass('hover');},mouseleave:function(){this.removeClass('hover');this.blur();},mousedown:function(){this.focus();}});},onFail:function(error){switch(error){case'flash':self.options.requestOptions.flashEnable=false;$$('.swiff-uploader-box').destroy();}},onSelectSuccess:function(){self.makeLoading('invisible');self.getForm().getElements('.compose-activator').each(function(element){element.setStyle('display','none');});this.start();},onFileSuccess:function(file,response){var json=new Hash(JSON.decode(response,true)||{});self.doProcessResponse(json);}},options.fancyUploadOptions);try{this.elements.formFancyUpload=new FancyUpload2(this.elements.formFancyStatus,this.elements.formFancyList,opts);}catch(e){}
setTimeout(function(){self.elements.form.setStyle('height','auto');self.elements.formInput.setStyle('opacity','1');},1000);},doRequest:function(){this.elements.iframe=new IFrame({'name':'composePhotoFrame','src':'javascript:false;','styles':{'display':'none'},'events':{'load':function(){this.doProcessResponse(window._composePhotoResponse);window._composePhotoResponse=false;}.bind(this)}}).inject(this.elements.body);window._composePhotoResponse=false;this.elements.form.set('target','composePhotoFrame');this.elements.form.submit();this.elements.form.destroy();this.getForm().getElements('.compose-activator').each(function(element){element.setStyle('display','none');});this.makeLoading();},doProcessResponse:function(responseJSON){if(($type(responseJSON)!='hash'&&$type(responseJSON)!='object')||$type(responseJSON.src)!='string'||$type(parseInt(responseJSON.photo_id))!='number'){this.elements.loading.destroy();this.elements.body.empty();if(responseJSON.error=='Invalid data'){this.makeError(this._lang('The image you tried to upload exceeds the maximum file size.'),'empty');}
else{this.makeError(this._lang('Unable to upload photo.'),'empty');}
return;}
this.params.set('rawParams',responseJSON);this.params.set('photo_id',responseJSON.photo_id);this.params.set('src',responseJSON.src);this.elements.preview=Asset.image(responseJSON.src,{'id':'compose-photo-preview-image','class':'compose-preview-image','onload':this.doImageLoaded.bind(this)});},doImageLoaded:function(){if($('compose-photo-error')){$('compose-photo-error').destroy();}
if(this.elements.loading)this.elements.loading.destroy();this.elements.preview.erase('width');this.elements.preview.erase('height');this.elements.preview_image.setStyle('display','block');this.elements.preview.inject(this.elements.preview_image);this.makeFormInputs({photo_id:this.params.photo_id,type:'photo',src:this.params.src});this.makeMenu(1);},makeFormInputs:function(data){$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){if($(key))
$(key).destroy();this.elements.hiddenElement=new Element('input',{'type':'hidden','id':key,'name':'attachment['+key+']','value':value||''});this.elements.hiddenElement.inject(this.elements.textarea);},_lang:function(){try{if(arguments.length<1){return'';}
var string=arguments[0];if($type(this.options.lang)&&$type(this.options.lang[string])){string=this.options.lang[string];}
if(arguments.length<=1){return string;}
var args=new Array();for(var i=1,l=arguments.length;i<l;i++){args.push(arguments[i]);}
return string.vsprintf(args);}catch(e){alert(e);}},makeLoading:function(action){if(!this.elements.loading){if(action=='empty'){this.elements.body.empty();}else if(action=='hide'){this.elements.body.getChildren().each(function(element){element.setStyle('display','none')});}else if(action=='invisible'){this.elements.body.getChildren().each(function(element){if(element.get('id')!='nested_preview_image'){element.setStyle('height','0px').setStyle('visibility','hidden');}else{}});}
this.elements.loading=new Element('div',{'id':'compose-nested-photo-loading','class':'compose-loading mtop5'}).inject(this.elements.body);var image=this.elements.loadingImage||(new Element('img',{'id':'compose-nested-photo-loading-image','class':'compose-loading-image','src':en4.core.staticBaseUrl+'application/modules/Seaocore/externals/images/core/loading.gif'}));image.inject(this.elements.loading);new Element('span',{'html':this._lang('Loading...')}).inject(this.elements.loading);}},makeMenu:function(test){if(test==0)
return;if(!this.elements.menu){var tray=this.getTray();this.elements.menu=new Element('div',{'id':'compose-nested-comment-photo-menu','class':'compose-menu'}).inject(tray);this.elements.menuTitle=new Element('span',{}).inject(this.elements.menu);this.elements.menuClose=new Element('a',{'href':'javascript:void(0);','class':'nestcomment_icon_cross buttonlink','events':{'click':function(e){e.stop();this.elements.tray.destroy();if($('photo_id'))
$('photo_id').destroy();if($('type'))
$('type').destroy();if($('src'))
$('src').destroy();this.getForm().getElements('.compose-activator').each(function(element){element.setStyle('display','');});this.getPhotoContent(this.elements.textarea,{requestOptions:{'url':requestOptionsURLNestedComment},fancyUploadOptions:{'url':fancyUploadOptionsURLNestedComment,'path':en4.core.basePath+'externals/fancyupload/Swiff.Uploader.swf'}});}.bind(this)}}).inject(this.elements.menuTitle);}},emptyTray:function(){if($('compose-photo-preview-image'))
$('compose-photo-preview-image').destroy();$('compose-nested-comment-photo-body').style.display='block';$('compose-nested-comment-photo-body').erase('height');},getTray:function(){if(!$type(this.elements.tray)){this.elements.tray=$try(function(){return $(this.options.trayElement);}.bind(this));if(!$type(this.elements.tray)){this.elements.tray=new Element('div',{'id':'compose-tray','class':'compose-tray','styles':{'display':'block'}}).inject(this.getForm());}}
return this.elements.tray;},makeBody:function(){if(!this.elements.body){var tray=this.getTray();this.elements.body=new Element('div',{'id':'compose-nested-comment-photo-body','class':'compose-body'}).inject(tray);}},getForm:function(){return this.elements.textarea;},signalPluginReady:function(state){this.pluginReady=state;},ready:function(){this.signalPluginReady(true);},reset:function(){this.elements.each(function(element,key){if($type(element)=='element'&&!this.persistentElements.contains(key)){element.destroy();this.elements.erase(key);}}.bind(this));this.params=new Hash();this.elements=new Hash();},makeError:function(message,action){if(!$type(action))
action='empty';message=message||'An error has occurred';message=this._lang(message);this.elements.error=new Element('div',{'id':'nested-compose-photo-error','class':'compose-error','html':message}).inject(this.elements.body);}});;ComposerNestedComment.Plugin.Nctag=new Class({Extends:ComposerNestedComment.Plugin.Interface,name:'tag',options:{'enabled':false,requestOptions:{},'suggestOptions':{'minLength':0,'maxChoices':100,'delay':250,'selectMode':'pick','multiple':false,'filterSubset':true,'tokenFormat':'object','tokenValueKey':'label','injectChoice':$empty,'onPush':$empty,'prefetchOnInit':true,'alwaysOpen':false,'ignoreKeys':true,'stopKeysEvent':false}},initialize:function(options){this.params=new Hash(this.params);this.parent(options);},suggest:false,attach:function(){this.parent();var self=this;this.getComposer().addEvent((1)?'editorKeyDown':'editorKeyPress',function(event){if(self.suggest&&self.suggest.visible&&event){self.suggest.onCommand(event);if(self.suggest.stopKeysEvent){event.stop();return;}}
self.monitor.bind(self)(event);});this.getComposer().addEvent('editorClick',this.monitor.bind(this));this.getComposer().addEvent('editorSubmit',this.submit.bind(this));return this;},detach:function(){if(!this.options.enabled)
return;this.parent();this.getComposer().removeEvent('editorKeyPress',this.monitor.bind(this));this.getComposer().removeEvent('editorClick',this.monitor.bind(this));this.getComposer().removeEvent('editorSubmit',this.submit.bind(this));if(this.interval)
$clear(this.interval);return this;},activate:$empty,deactivate:$empty,poll:function(){},monitor:function(e){(function(){var selection=this.getComposer().selection;var range=selection.getRange();if(!range)
return;var start=0;if(window.getSelection){start=range.startOffset;}else if(document.selection){var range_t=document.selection.createRange();if(range_t==null||range_t['text']==null){}else{var textlength=selection.win.innerText.length;range.moveStart("character",-textlength);start=range.text.length;}}
var content=null;if(range.startContainer){content=range.startContainer.data;}else if(selection.win){content=selection.win.innerText;}
if(!content)
return;this.filterAAFTagsFromComposer();var currentIndex=false;content=content.substring(0,start);currentIndex=content.lastIndexOf('@');if(currentIndex==-1||currentIndex>=start||currentIndex+10<=start){this.endSuggest();return;}
var segment=content.substring(currentIndex+1,start);var spaceIndex=segment.indexOf(' ');if(spaceIndex>-1){if(currentIndex+spaceIndex<start){this.endSuggest();return;}else{segment=segment.substring(0,spaceIndex);}}
if(segment==''){this.endSuggest();return;}
this.doSuggest(segment);}).delay(5,this);},doSuggest:function(text){this.currentText=text;var suggest=this.getSuggest();var input=this.getHiddenInput();input.set('value',text);input.value=text;suggest.prefetch();},endSuggest:function(){this.currentText='';this.positions={};if(this.suggest){this.getSuggest().destroy();delete this.suggest;}},getHiddenInput:function(){if(!this.hiddenInput){this.hiddenInput=new Element('input',{'type':'text','styles':{'display':'none'}}).inject(document.body);}
return this.hiddenInput;},getSuggest:function(){if(!this.suggest){var width=this.getComposer().elements.body.getSize().x;this.choices=new Element('ul',{'class':'tag-autosuggest seaocore-autosuggest','styles':{'width':(width-2)+'px'}}).inject(this.getComposer().elements.body,'after');var self=this;var options=$merge(this.options.suggestOptions,{'customChoices':this.choices,'injectChoice':function(token){var choice=new Element('li',{'class':'autocompleter-choices','html':token.photo||'','id':token.guid});var divEl=new Element('div',{'html':this.markQueryValue(token.label),'class':'autocompleter-choice'});if(token.type!='user'){new Element('div',{'html':this.markQueryValue(token.type)}).inject(divEl);}
divEl.inject(choice);new Element('input',{'type':'hidden','value':JSON.encode(token)}).inject(choice);this.addChoiceEvents(choice).inject(this.choices);choice.store('autocompleteChoice',token);},'onChoiceSelect':function(choice){var data=JSON.decode(choice.getElement('input').value);var composer=self.getComposer();var body=composer.elements.body;var content=null;if(composer._supportsContentEditable()){content=composer.elements.body.get('html');}else{content=composer.elements.body.get('value');}
var replaceString='@'+self.currentText;var newString='<span class="aaf_feed_composer_tag" rel="'+data.guid+'" rev="'+data.label+'" >'+data.label+'</span>&nbsp;';content=content.replace(/\<span\>\<\/span\>/ig,'');content=content.replace(new RegExp(replaceString,'i'),newString);composer.setContent(content);var tagElement=self.getAAFTagElementFromComposer(data.label);if(window.getSelection){composer.selection.getSelection().collapse(tagElement.nextSibling,1);}else if(document.selection){composer.selection.getRange().moveToElementText(tagElement);}},'emptyChoices':function(){this.fireEvent('onHide',[this.element,this.choices]);},'onCommand':function(e){if(e&&e.key&&!e.shift){switch(e.key){case'enter':e.stop();if(!this.selected){if(!this.options.customChoices){this.element.value='';}
return true;}
if(this.selected&&this.visible){this.stopKeysEvent=true;this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}
break;case'up':case'down':var value=this.element.value;if(!this.prefetch()&&this.queryValue!==null){this.stopKeysEvent=true;var up=(e.key=='up');if(this.selected)
this.selected.removeClass('autocompleter-selected');if(!(this.selected)[((up)?'getPrevious':'getNext')](this.options.choicesMatch)){this.selected=null;}
this.choiceOver((this.selected||this.choices)[(this.selected)?((up)?'getPrevious':'getNext'):((up)?'getLast':'getFirst')](this.options.choicesMatch),true);this.element.value=value;}
return false;case'esc':this.stopKeysEvent=true;this.hideChoices(true);if(!this.options.customChoices)
this.element.value='';break;case'tab':this.stopKeysEvent=true;if(this.selected&&this.visible){this.choiceSelect(this.selected);return!!(this.options.autoSubmit);}else{this.hideChoices(true);if(!this.options.customChoices)
this.element.value='';break;}
default:this.stopKeysEvent=false;}}}});if(this.options.suggestProto=='local'){this.suggest=new Autocompleter.Local(this.getHiddenInput(),this.options.suggestParam,options);}else if(this.options.suggestProto=='request.json'){this.suggest=new Autocompleter.Request.JSON(this.getHiddenInput(),this.options.suggestOptions.url,options);}
if(this.suggest&&!this.suggest.options.alwaysOpen){this.getComposer().elements.body.addEvent('blur',this.suggestHideChoices.create({bind:this}));}}
return this.suggest;},suggestHideChoices:function(){var suggest=this.suggest;if(suggest){suggest.hideChoices(true);if(!suggest.options.customChoices)
suggest.element.value='';}},filterAAFTagsFromComposer:function()
{var body=this.getComposer().elements.body;body.getElements('.aaf_feed_composer_tag').each(function(tag){if(tag.get('text')!=tag.get('rev')){tag.removeClass('aaf_feed_composer_tag');}});},getAAFTagElementFromComposer:function(text){var body=this.getComposer().elements.body;var element=null;body.getElements('.aaf_feed_composer_tag').each(function(tag){if(tag.get('text')==tag.get('rev')&&tag.get('text')==text.replace(/&#039;/ig,'\'')){element=tag;}});return element;},submit:function(){this.makeFormInputs({tag:this.getAAFTagsFromComposer().toQueryString()});},getAAFTagsFromComposer:function()
{this.filterAAFTagsFromComposer();var composerTags=new Hash();var body=this.getComposer().elements.body;body.getElements('.aaf_feed_composer_tag').each(function(tag){composerTags[tag.get('rel')]=tag.get('text');});return composerTags;},makeFormInputs:function(data){$H(data).each(function(value,key){this.setFormInputValue(key,value);}.bind(this));},setFormInputValue:function(key,value){var elName='aafComposerForm'+key.capitalize();var composerObj=this.getComposer();if(composerObj.elements.has(elName))
composerObj.elements.get(elName).destroy();composerObj.elements.set(elName,new Element('input',{'type':'hidden','name':'composer['+key+']','value':value||''}).inject(composerObj.getInputArea()));composerObj.elements.get(elName).value=value;}});;function nestedcomment_content_type_likes(resource_id,resource_type){content_type_undefined=0;var content_type=nestedcomment_content_type;if(nestedcomment_content_type===''){content_type_undefined=1;var content_type=resource_type;}
var request=nestedcomment_content_create_like(resource_id,resource_type,content_type);request.addEvent('complete',function(responseJSON){if(content_type_undefined===0){if(responseJSON.like_id){if($(content_type+'_like_'+resource_id))
$(content_type+'_like_'+resource_id).value=responseJSON.like_id;if($(content_type+'_most_likes_'+resource_id))
$(content_type+'_most_likes_'+resource_id).style.display='none';if($(content_type+'_unlikes_'+resource_id))
$(content_type+'_unlikes_'+resource_id).style.display='inline-block';if($(content_type+'_num_of_like_'+resource_id)){$(content_type+'_num_of_like_'+resource_id).innerHTML=responseJSON.num_of_like;}}else{if($(content_type+'_like_'+resource_id))
$(content_type+'_like_'+resource_id).value=0;if($(content_type+'_most_likes_'+resource_id))
$(content_type+'_most_likes_'+resource_id).style.display='inline-block';if($(content_type+'_unlikes_'+resource_id))
$(content_type+'_unlikes_'+resource_id).style.display='none';if($(content_type+'_num_of_like_'+resource_id)){$(content_type+'_num_of_like_'+resource_id).innerHTML=responseJSON.num_of_like;}}}});}
function nestedcomment_content_create_like(resource_id,resource_type,content_type){if($(content_type+'_like_'+resource_id)){var like_id=$(content_type+'_like_'+resource_id).value;}
var request=new Request.HTML({url:en4.core.baseUrl+'nestedcomment/like/like',data:{format:'html','resource_id':resource_id,'resource_type':resource_type,'like_id':like_id},onComplete:function(responseTree,responseElements,responseHTML,responseJavaScript){}});request.send();return request;};(function(){var $='id'in document?document.id:window.$;ComposerNestedComment.Plugin.Photo=new Class({Extends:ComposerNestedComment.Plugin.Interface,name:'photo',options:{title:'Add Photo',lang:{},requestOptions:false,fancyUploadEnabled:true,fancyUploadOptions:{}},initialize:function(options){this.elements=new Hash(this.elements);this.params=new Hash(this.params);this.parent(options);},attach:function(){this.parent();this.makeActivator();return this;},detach:function(){this.parent();return this;},activate:function(){if(this.active)
return;this.parent();this.makeMenu();this.makeBody();var fullUrl=this.options.requestOptions.url;this.elements.form=new Element('form',{'id':'compose-photo-form','class':'compose-form','method':'post','action':fullUrl,'enctype':'multipart/form-data'}).inject(this.elements.body);this.elements.formInput=new Element('input',{'id':'compose-photo-form-input','class':'compose-form-input','type':'file','name':'Filedata','events':{'change':this.doRequest.bind(this)}}).inject(this.elements.form);if(this.options.fancyUploadEnabled&&this.options.fancyUploadOptions){if(typeof composeInstanceComment.getForm().comment_id!='undefined'&&composeInstanceComment.getForm().comment_id.value){if($('close_edit_box-'+composeInstanceComment.getForm().comment_id.value))
$('close_edit_box-'+composeInstanceComment.getForm().comment_id.value).style.display='none';}
this.elements.formFancyContainer=new Element('div',{'styles':{'visibility':'hidden'}}).inject(this.elements.body);this.elements.formFancyFile=new Element('a',{'href':'javascript:void(0);','id':'compose-photo-form-fancy-file','class':'buttonlink','html':this._lang('Select File')}).inject(this.elements.formFancyContainer);this.elements.formFancyStatus=new Element('div',{'html':'<div style="display:none;">\n\
  <div class="demo-status-overall" id="demo-status-overall" style="display:none;">\n\
    <div class="overall-title"></div>\n\
    <img src="" class="progress overall-progress" />\n\
  </div>\n\
  <div class="demo-status-current" id="demo-status-current" style="display:none;">\n\
    <div class="current-title"></div>\n\
    <img src="" class="progress current-progress" />\n\
  </div>\n\
  <div class="current-text"></div>\n\
</div>'}).inject(this.elements.formFancyContainer);this.elements.formFancyList=new Element('div',{'styles':{'display':'none'}}).inject(this.elements.formFancyContainer);var self=this;var opts=$merge({policyFile:('https:'==document.location.protocol?'https://':'http://')
+document.location.host
+en4.core.baseUrl+'cross-domain',url:fullUrl,appendCookieData:true,multiple:false,typeFilter:{'Images (*.jpg, *.jpeg, *.gif, *.png)':'*.jpg; *.jpeg; *.gif; *.png'},target:this.elements.formFancyFile,container:self.elements.body,onLoad:function(){self.elements.formFancyContainer.setStyle('display','');self.elements.formFancyContainer.setStyle('visibility','visible');self.elements.form.destroy();this.target.addEvents({click:function(){return false;},mouseenter:function(){this.addClass('hover');},mouseleave:function(){this.removeClass('hover');this.blur();},mousedown:function(){this.focus();}});},onSelectSuccess:function(){if($('nested-compose-photo-menu'))
$('nested-compose-photo-menu').style.display='none';self.makeLoading('invisible');this.start();},onFileSuccess:function(file,response){var json=new Hash(JSON.decode(response,true)||{});self.doProcessResponse(json);}},this.options.fancyUploadOptions);try{this.elements.formFancyUpload=new FancyUpload2(this.elements.formFancyStatus,this.elements.formFancyList,opts);}catch(e){}}},deactivate:function(){if(!this.active)
return;this.parent();},doRequest:function(){this.elements.iframe=new IFrame({'name':'composePhotoFrame','src':'javascript:false;','styles':{'display':'none'},'events':{'load':function(){this.doProcessResponse(window._composePhotoResponse);window._composePhotoResponse=false;}.bind(this)}}).inject(this.elements.body);window._composePhotoResponse=false;this.elements.form.set('target','composePhotoFrame');this.elements.form.submit();this.elements.form.destroy();this.makeLoading();},doProcessResponse:function(responseJSON){if(($type(responseJSON)!='hash'&&$type(responseJSON)!='object')||$type(responseJSON.src)!='string'||$type(parseInt(responseJSON.photo_id))!='number'){this.makeError(this._lang('Unable to upload photo. Please click cancel and try again'),'empty');return;}
this.params.set('rawParams',responseJSON);this.params.set('photo_id',responseJSON.photo_id);this.elements.preview=Asset.image(responseJSON.src,{'id':'compose-photo-preview-image','class':'compose-preview-image','onload':this.doImageLoaded.bind(this)});if($('nested-compose-photo-menu'))
$('nested-compose-photo-menu').style.display='block';},doImageLoaded:function(){if($('compose-photo-error')){$('compose-photo-error').destroy();}
if(this.elements.loading)
this.elements.loading.destroy();if(this.elements.formFancyContainer)
this.elements.formFancyContainer.destroy();this.elements.preview.erase('width');this.elements.preview.erase('height');this.elements.preview.inject(this.elements.body);this.makeFormInputs();},makeFormInputs:function(){this.ready();this.parent({'photo_id':this.params.photo_id});}});})();